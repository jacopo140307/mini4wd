<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mini4WD Advisor • Lite (B‑MAX / TMEC)</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --ink:#e6eeff; --muted:#9fb3ff; --line:#223258;
  --accent:#22d3ee; --chassis:#203a65; --hole:#93c5fd; --allowed:#22d3ee;
  --plate:#38bdf8; --roller:#22e3ab; --damper:#ffd166; --brake:#ff5370; --weight:#b8ff5a; --fastener:#cfd8dc;
}
*{box-sizing:border-box} html,body{margin:0;background:linear-gradient(180deg,#0b1220,#081124);color:var(--ink);font-family:Inter,system-ui,-apple-system}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
h1{margin:6px 0 12px;font-size:clamp(22px,3vw,30px)}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;margin:10px 0}
.panel h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--line);font-size:16px}
.panel .body{padding:12px 16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,input,button{border-radius:10px;border:1px solid var(--line);background:#0d1530;color:#e6eeff;padding:8px 10px}
button.primary{background:linear-gradient(90deg,#7c3aed,#22d3ee);border:0}
.muted{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:8px;margin:8px 0}
.tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0d1530;cursor:pointer}
.tab.active{border-color:var(--accent)}
canvas,svg{width:100%;height:auto;border:1px solid var(--line);border-radius:14px;background:#0a0f1e}
.grid{display:grid;gap:12px}
@media(min-width:1050px){.g2{grid-template-columns:420px 1fr}}
.hole{fill:var(--hole);stroke:#89c2ff;stroke-width:.35}
.allowed{fill:none;stroke:var(--allowed);stroke-dasharray:2 2;stroke-width:.6;opacity:.7}
.chip{border:1px solid var(--line);background:#0d1530;padding:7px 10px;border-radius:10px;cursor:pointer}
.chip.active{border-color:#22d3ee;box-shadow:0 0 0 2px rgba(34,211,238,.15) inset}
.badge{display:inline-block;padding:2px 6px;border-radius:8px;font-size:11px;margin-left:6px}
.bmax{background:#0b3b2a;color:#b9ffd6} .tmec{background:#3b1a0b;color:#ffd6b9}
.list{font-size:14px;line-height:1.6}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h1>Mini4WD Advisor • Lite <span class="badge bmax">B‑MAX</span> <span class="badge tmec">TMEC</span></h1>
    <div class="muted">Accesso locale: <span id="who">ospite</span></div>
  </div>

  <div class="panel">
    <h2>Accesso</h2>
    <div class="body row">
      <input id="u" placeholder="Username">
      <input id="p" placeholder="Password" type="password">
      <button id="login">Entra</button>
      <button id="logout" style="display:none">Logout</button>
      <div class="muted">Credenziali salvate in locale sul dispositivo.</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="analyzer">Analisi Pista</div>
    <div class="tab" data-tab="advisor">Consigli & Simulazioni</div>
    <div class="tab" data-tab="builder">Layout Builder</div>
    <div class="tab" data-tab="catalog">Catalogo</div>
  </div>

  <!-- ANALYZER -->
  <div class="panel" id="analyzer">
    <h2>Analizzatore pista (solo Canvas, nessuna libreria)</h2>
    <div class="body grid g2">
      <div>
        <div class="row">
          <label>Regolamento
            <select id="rules"><option>B-MAX</option><option>TMEC</option></select>
          </label>
          <label>Chassis
            <select id="chassisSel"></select>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="imgs" type="file" accept="image/*" multiple>
          <button id="run" class="primary">Analizza</button>
          <button id="pdf">PDF</button>
        </div>
        <p class="muted">Funziona bene con poster/render Tamiya e foto reali. Maschera i grigi della pista, estrae i bordi (Sobel) e misura la percentuale di curve.</p>
        <div class="list" id="profile"></div>
      </div>
      <div><canvas id="cMain" width="960" height="540"></canvas></div>
    </div>
  </div>

  <!-- ADVISOR -->
  <div class="panel" id="advisor" style="display:none">
    <h2>Consigli & Simulazioni</h2>
    <div class="body grid g2">
      <div>
        <button id="simulate" class="primary">Esegui simulazione (Top‑3)</button>
        <div class="list" id="advice" style="margin-top:8px"></div>
      </div>
      <div>
        <canvas id="cAdv" width="960" height="540"></canvas>
        <div class="muted" style="margin-top:6px">Visualizzazione punti di montaggio (fori) e posizionamento raccomandato.</div>
      </div>
    </div>
  </div>

  <!-- BUILDER -->
  <div class="panel" id="builder" style="display:none">
    <h2>Layout Builder (snap fori)</h2>
    <div class="body grid g2">
      <div>
        <div class="row">
          <label>Vista
            <select id="view">
              <option value="top">Sopra</option><option value="bottom">Sotto</option>
              <option value="left">Lato sinistro</option><option value="right">Lato destro</option>
              <option value="front">Fronte</option><option value="rear">Retro</option>
              <option value="iso">Isometrica</option>
            </select>
          </label>
          <label>Chassis
            <select id="chassis"></select>
          </label>
          <label>Categoria
            <select id="cat"></select>
          </label>
          <label>Componente
            <select id="comp"></select>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="place" class="chip">Aggancia</button>
          <button id="move" class="chip">Sposta</button>
          <button id="del" class="chip">Rimuovi</button>
          <button id="reset">Reset</button>
          <button id="exportLayout" class="primary">Export layout JSON</button>
        </div>
      </div>
      <div>
        <svg id="stage" viewBox="-110 -80 220 160" xmlns="http://www.w3.org/2000/svg">
          <defs><pattern id="mm" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M10 0H0V10" fill="none" stroke="#213050" stroke-width="0.25"/></pattern></defs>
          <rect x="-110" y="-80" width="220" height="160" fill="url(#mm)"/>
          <g id="shape"></g><g id="allowed"></g><g id="holes"></g><g id="parts"></g>
        </svg>
      </div>
    </div>
  </div>

  <!-- CATALOG -->
  <div class="panel" id="catalog" style="display:none">
    <h2>Catalogo (cache locale minima)</h2>
    <div class="body">
      <div id="catList" class="list"></div>
      <div class="muted">Per il catalogo completo “solo Tamiya” potremo collegare un micro‑proxy CORS; questa versione è subito utilizzabile offline.</div>
    </div>
  </div>
</div>

<script>
/* ===== Accesso locale ===== */
const who=document.getElementById('who');
document.getElementById('login').onclick=()=>{localStorage.m4_user=document.getElementById('u').value;localStorage.m4_pass=document.getElementById('p').value;who.textContent=localStorage.m4_user||'ospite';document.getElementById('logout').style.display='inline-block';}
document.getElementById('logout').onclick=()=>{delete localStorage.m4_user;delete localStorage.m4_pass;who.textContent='ospite';document.getElementById('logout').style.display='none';}
if(localStorage.m4_user){who.textContent=localStorage.m4_user;document.getElementById('logout').style.display='inline-block';}

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');
    ['analyzer','advisor','builder','catalog'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById(t.dataset.tab).style.display='';};
});

/* ===== Chassis DB (fori + sagome semplificate coerenti in mm) ===== */
const CHASSIS={
  SUPER2: mkChassis('Super‑II',{path:'M -70,-30 L -78,0 L -70,30 L 70,30 L 78,0 L 70,-30 Z',holes:[{id:'F1',x:-84,y:-10},{id:'F2',x:-84,y:10},{id:'F3',x:-72,y:0},{id:'C1',x:-20,y:-12},{id:'C2',x:-20,y:12},{id:'C3',x:20,y:-12},{id:'C4',x:20,y:12},{id:'R1',x:84,y:-10},{id:'R2',x:84,y:10},{id:'R3',x:72,y:0}]}),
  MA:     mkChassis('MA',{path:'M -68,-28 L -76,0 L -68,28 L 68,28 L 76,0 L 68,-28 Z',holes:[{id:'F1',x:-82,y:-10},{id:'F2',x:-82,y:10},{id:'F3',x:-70,y:0},{id:'C1',x:-18,y:-12},{id:'C2',x:-18,y:12},{id:'C3',x:18,y:-12},{id:'C4',x:18,y:12},{id:'R1',x:82,y:-10},{id:'R2',x:82,y:10},{id:'R3',x:70,y:0}]}),
  MS:     mkChassis('MS',{path:'M -66,-26 L -74,0 L -66,26 L 66,26 L 74,0 L 66,-26 Z',holes:[{id:'F1',x:-80,y:-10},{id:'F2',x:-80,y:10},{id:'F3',x:-68,y:0},{id:'C1',x:-16,y:-11},{id:'C2',x:-16,y:11},{id:'C3',x:16,y:-11},{id:'C4',x:16,y:11},{id:'R1',x:80,y:-10},{id:'R2',x:80,y:10},{id:'R3',x:68,y:0}]}),
  AR:     mkChassis('AR',{path:'M -69,-28 L -77,0 L -69,28 L 69,28 L 77,0 L 69,-28 Z',holes:[{id:'F1',x:-83,y:-10},{id:'F2',x:-83,y:10},{id:'F3',x:-71,y:0},{id:'C1',x:-19,y:-12},{id:'C2',x:-19,y:12},{id:'C3',x:19,y:-12},{id:'C4',x:19,y:12},{id:'R1',x:83,y:-10},{id:'R2',x:83,y:10},{id:'R3',x:71,y:0}]}),
  VS:     mkChassis('VS',{path:'M -64,-24 L -72,0 L -64,24 L 64,24 L 72,0 L 64,-24 Z',holes:[{id:'F1',x:-78,y:-9},{id:'F2',x:-78,y:9},{id:'F3',x:-66,y:0},{id:'C1',x:-16,y:-10},{id:'C2',x:-16,y:10},{id:'C3',x:16,y:-10},{id:'C4',x:16,y:10},{id:'R1',x:78,y:-9},{id:'R2',x:78,y:9},{id:'R3',x:66,y:0}]}),
  VZ:     mkChassis('VZ',{path:'M -66,-26 L -74,0 L -66,26 L 66,26 L 74,0 L 66,-26 Z',holes:[{id:'F1',x:-84,y:-10},{id:'F2',x:-84,y:10},{id:'F3',x:-72,y:0},{id:'C1',x:-18,y:-12},{id:'C2',x:-18,y:12},{id:'C3',x:18,y:-12},{id:'C4',x:18,y:12},{id:'R1',x:84,y:-10},{id:'R2',x:84,y:10},{id:'R3',x:72,y:0}]}),
  FM_A:   mkChassis('FM‑A',{path:'M -66,-26 L -74,0 L -66,26 L 66,26 L 74,0 L 66,-26 Z',holes:[{id:'F1',x:-82,y:-10},{id:'F2',x:-82,y:10},{id:'F3',x:-70,y:0},{id:'C1',x:-18,y:-12},{id:'C2',x:-18,y:12},{id:'C3',x:18,y:-12},{id:'C4',x:18,y:12},{id:'R1',x:82,y:-10},{id:'R2',x:82,y:10},{id:'R3',x:70,y:0}]}),
  SUPERXX:mkChassis('Super‑XX',{path:'M -72,-30 L -80,0 L -72,30 L 72,30 L 80,0 L 72,-30 Z',holes:[{id:'F1',x:-88,y:-10},{id:'F2',x:-88,y:10},{id:'F3',x:-76,y:0},{id:'C1',x:-22,y:-12},{id:'C2',x:-22,y:12},{id:'C3',x:22,y:-12},{id:'C4',x:22,y:12},{id:'R1',x:88,y:-10},{id:'R2',x:88,y:10},{id:'R3',x:76,y:0}]})
};
function mkChassis(name, s){
  return { name, outline:{top:{type:'path',d:s.path},bottom:{type:'path',d:s.path},
    left:{type:'rect',x:-78,y:-18,w:156,h:36,rx:8}, right:{type:'rect',x:-78,y:-18,w:156,h:36,rx:8},
    front:{type:'rect',x:-45,y:-20,w:90,h:40,rx:8}, rear:{type:'rect',x:-45,y:-20,w:90,h:40,rx:8}, iso:{type:'path',d:s.path}},
    holes:{top:s.holes,bottom:s.holes}, allowed:{top:[],bottom:[]} };
}

/* ===== Catalogo minimo ===== */
let CATALOG={
  roller:{"Roller 19mm Alluminio (ITEM 15459)":{code:"15459",mass:3.2,draw:{type:"circle",r:9.5,fill:"var(--roller)"}},
          "Roller 13mm Alluminio (ITEM 15413)":{code:"15413",mass:1.9,draw:{type:"circle",r:6.5,fill:"var(--roller)"}}},
  plate: {"FRP Front Wide (ITEM 15430)":{code:"15430",mass:6.8,draw:{type:"rect",w:60,h:10,rx:4,fill:"var(--plate)"}},
          "FRP Rear Multi (ITEM 15518)":{code:"15518",mass:7.2,draw:{type:"rect",w:60,h:10,rx:4,fill:"var(--plate)"}}},
  damper:{"Mass Damper 12g (ITEM 15441)":{code:"15441",mass:12,draw:{type:"circle",r:6,fill:"var(--damper)"}},
          "Mass Damper 8g (ITEM 15440)":{code:"15440",mass:8,draw:{type:"circle",r:5.2,fill:"var(--damper)"}}},
  brake: {"Sponge Brake 1mm (ITEM 15423)":{code:"15423",mass:1.5,draw:{type:"rect",w:32,h:3,rx:1.5,fill:"var(--brake)"}},
          "Sponge Brake 0.5mm (ITEM 15422)":{code:"15422",mass:1.0,draw:{type:"rect",w:32,h:3,rx:1.5,fill:"var(--brake)"}}},
  weight:{"Ottone 6x12 (ITEM 15524)":{code:"15524",mass:3.0,draw:{type:"rect",w:12,h:4,rx:1.2,fill:"var(--weight)"}}},
  gear:  {"3.5:1 High-Speed (ITEM 15349)":{code:"15349",mass:1.2,draw:{type:"circle",r:7,fill:"#ffe08a"}},
          "4:1 High-Speed (ITEM 15355)":{code:"15355",mass:1.2,draw:{type:"circle",r:7,fill:"#ffe08a"}}},
  motor: {"Hyper‑Dash 3":{code:"",mass:17,draw:{type:"rect",w:12,h:8,rx:1.4,fill:"#8ab4f8"}}},
  fastener:{"Vite 2x8":{code:"",mass:0.2,draw:{type:"rect",w:2,h:8,rx:.5,fill:"var(--fastener)"}},
            "Rondella 2mm":{code:"",mass:0.05,draw:{type:"circle",r:1.5,fill:"var(--fastener)"}},
            "Distanziale 2x5":{code:"",mass:0.1,draw:{type:"rect",w:5,h:2,rx:.5,fill:"var(--fastener)"}}}
};

/* ===== Selectors ===== */
const chassisSel1=document.getElementById('chassisSel'), chassisSel2=document.getElementById('chassis');
const catSel=document.getElementById('cat'), compSel=document.getElementById('comp');
function fillSelectors(){
  const keys=Object.keys(CHASSIS);
  chassisSel1.innerHTML=keys.map(k=>`<option value="${k}">${CHASSIS[k].name}</option>`).join('');
  chassisSel2.innerHTML=keys.map(k=>`<option value="${k}">${CHASSIS[k].name}</option>`).join('');
  const cats=Object.keys(CATALOG); catSel.innerHTML=cats.map(k=>`<option value="${k}">${k}</option>`).join(''); fillComp();
}
function fillComp(){ const cat=catSel.value; const list=Object.keys(CATALOG[cat]||{}); compSel.innerHTML=list.map(n=>`<option>${n}</option>`).join(''); }

/* ===== ANALYZER senza librerie: HSV mask + Sobel + istogramma angoli ===== */
const cMain=document.getElementById('cMain'), ctxMain=cMain.getContext('2d');
let lastProfile=null;

document.getElementById('run').onclick=async()=>{
  const files=[...document.getElementById('imgs').files]; if(!files.length){alert('Carica almeno una foto.');return;}
  const img=await fileToImg(files[0]);
  const scale=Math.min(1, cMain.width/img.naturalWidth); const w=Math.round(img.naturalWidth*scale), h=Math.round(img.naturalHeight*scale);
  cMain.width=w; cMain.height=h; ctxMain.drawImage(img,0,0,w,h);
  const id=ctxMain.getImageData(0,0,w,h);
  const mask=maskGrey(id); // pista (grigi)
  const edges=sobelEdges(mask,w,h,25); // > soglia
  drawMaskAndEdges(mask,edges,w,h);     // preview

  // istogramma orientazioni
  const hist=orientationHistogram(edges,w,h);
  const straightRatio=(hist.horiz+hist.vert)/Math.max(1,hist.total);
  const curvePct = Math.min(0.95, Math.max(0.05, 1-straightRatio));
  const tightCurves = Math.round(curvePct*10);

  // stime grossolane di salti/paraboliche da aree bianche allungate
  const bright=highBrightMask(id,0.93,0.12); // V alto, S basso
  const feats=countElongated(blendMask(mask,bright,w,h),w,h);
  const prof={ length_m:Math.max(20,(edges.count/250)), straight_pct:straightRatio, curve_pct:curvePct, tight_curves:tightCurves, jumps:feats.longRects, banked:feats.veryLong, slope_max:(feats.veryLong>0||feats.longRects>0)?10:6, surface:'liscia' };
  lastProfile=prof; showProfile(prof);

  const res=computeAdvice(prof, document.getElementById('rules').value, chassisSel1.value);
  renderAdvice(res);
};

function fileToImg(file){ return new Promise(r=>{ const i=new Image(); i.onload=()=>r(i); i.src=URL.createObjectURL(file); }); }
function rgb2hsv(r,g,b){ r/=255; g/=255; b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b); const v=max; const d=max-min; const s=max===0?0:d/max; let h=0; if(d!==0){ switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;} h/=6; } return [h,s,v]; }
function maskGrey(imgData){ const {data}=imgData; const w=imgData.width,h=imgData.height; const m=new Uint8ClampedArray(w*h); for(let y=0,idx=0,mi=0;y<h;y++){ for(let x=0;x<w;x++,idx+=4,mi++){ const r=data[idx],g=data[idx+1],b=data[idx+2]; const [hsv_h,hsv_s,hsv_v]=rgb2hsv(r,g,b); // pista: saturazione bassa, valore alto/medio
      m[mi] = (hsv_s<0.28 && hsv_v>0.55) ? 255 : 0; } } // maschera binaria
  // piccola chiusura morfologica manuale (3x3) per unire gap
  return morphClose(m,w,h,1);
}
function highBrightMask(imgData, vThr=0.93, sMax=0.12){ const {data,width:w,height:h}=imgData; const m=new Uint8ClampedArray(w*h); for(let i=0,mi=0;i<data.length;i+=4,mi++){ const [_,s,v]=rgb2hsv(data[i],data[i+1],data[i+2]); m[mi]=(v>vThr && s<sMax)?255:0; } return m; }
function blendMask(a,b,w,h){ const out=new Uint8ClampedArray(w*h); for(let i=0;i<out.length;i++) out[i]=(a[i]&&b[i])?255:0; return out; }
function morphClose(m,w,h,rad){ // dilata poi erode
  const d=dilate(m,w,h,rad); return erode(d,w,h,rad);
}
function dilate(m,w,h,rad){ const out=new Uint8ClampedArray(w*h); for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let v=0; for(let dy=-rad;dy<=rad;dy++)for(let dx=-rad;dx<=rad;dx++){ const xx=x+dx,yy=y+dy; if(xx>=0&&yy>=0&&xx<w&&yy<h){ if(m[yy*w+xx]){v=255;dx=dy=rad+1;} } } out[y*w+x]=v; } } return out; }
function erode(m,w,h,rad){ const out=new Uint8ClampedArray(w*h); for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let v=255; for(let dy=-rad;dy<=rad;dy++)for(let dx=-rad;dx<=rad;dx++){ const xx=x+dx,yy=y+dy; if(xx>=0&&yy>=0&&xx<w&&yy<h){ if(!m[yy*w+xx]){v=0;dx=dy=rad+1;} } } out[y*w+x]=v; } } return out; }
function sobelEdges(mask,w,h,th=25){ // su maschera binaria
  const Gx=[-1,0,1,-2,0,2,-1,0,1], Gy=[-1,-2,-1,0,0,0,1,2,1]; const mag=new Float32Array(w*h); const ang=new Float32Array(w*h); let count=0;
  for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ let sx=0,sy=0,ki=0; for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++,ki++){ const v=mask[(y+dy)*w+(x+dx)]/255; sx+=v*Gx[ki]; sy+=v*Gy[ki]; }
      const m=Math.hypot(sx,sy)*255; if(m>th){ mag[y*w+x]=m; ang[y*w+x]=Math.atan2(sy,sx); count++; } } }
  return {mag,ang,count,w,h};
}
function drawMaskAndEdges(mask,edges,w,h){
  const img=ctxMain.createImageData(w,h); for(let i=0,mi=0;i<img.data.length;i+=4,mi++){ const v=mask[mi]; img.data[i]=v?220:10; img.data[i+1]=v?220:12; img.data[i+2]=v?220:18; img.data[i+3]=255; }
  // overlay edges in arancio
  for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ const m=edges.mag[y*w+x]; if(m>0){ const i=(y*w+x)*4; img.data[i]=255; img.data[i+1]=120; img.data[i+2]=0; img.data[i+3]=255; } } }
  ctxMain.putImageData(img,0,0);
}
function orientationHistogram(edges,w,h){
  let horiz=0, vert=0, diag=0, total=0;
  for(let i=0;i<w*h;i++){ if(edges.mag[i]>0){ const a=Math.abs(edges.ang[i]); total++; if(a<0.26||Math.abs(a-Math.PI)<0.26) horiz++; else if(Math.abs(a-Math.PI/2)<0.26) vert++; else diag++; } }
  return {horiz,vert,diag,total};
}
function countElongated(mask,w,h){ // componenti con r.width>>r.height: ponti/rampe (euristico)
  const lab=new Int32Array(w*h); let label=0; const stats=[]; // BFS
  const qx=new Int32Array(w*h), qy=new Int32Array(w*h);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const idx=y*w+x; if(mask[idx]&&lab[idx]===0){ label++; let minx=x,maxx=x,miny=y,maxy=y,head=0,tail=0; qx[tail]=x; qy[tail]=y; tail++; lab[idx]=label;
      while(head<tail){ const cx=qx[head], cy=qy[head]; head++; for(const [dx,dy] of [[1,0],[-1,0],[0,1],[0,-1]]){ const nx=cx+dx, ny=cy+dy; if(nx>=0&&ny>=0&&nx<w&&ny<h){ const nidx=ny*w+nx; if(mask[nidx]&&lab[nidx]===0){ lab[nidx]=label; qx[tail]=nx; qy[tail]=ny; tail++; minx=Math.min(minx,nx); maxx=Math.max(maxx,nx); miny=Math.min(miny,ny); maxy=Math.max(maxy,ny); } } } }
      const ww=maxx-minx+1, hh=maxy-miny+1, area=ww*hh; if(area>2000) stats.push({ww,hh,ratio:ww/hh});
    }
  }
  let longRects=0, veryLong=0; for(const s of stats){ if(s.ratio>3) longRects++; if(s.ratio>4.5) veryLong++; }
  return {longRects,veryLong};
}
function showProfile(p){
  document.getElementById('profile').innerHTML =
    `<b>Lunghezza:</b> ${p.length_m.toFixed(1)} m<br>`+
    `<b>Rettifili:</b> ${(p.straight_pct*100|0)}% • <b>Curve:</b> ${(p.curve_pct*100|0)}% • <b>Curve strette:</b> ${p.tight_curves}<br>`+
    `<b>Salti:</b> ${p.jumps} • <b>Paraboliche:</b> ${p.banked} • <b>Pendenza max:</b> ${p.slope_max.toFixed(1)}°<br>`+
    `<b>Superficie:</b> ${p.surface}`;
}

/* ===== Advisor & Sim ===== */
document.getElementById('simulate').onclick=()=>{ if(!lastProfile){alert('Esegui prima l’analisi.');return;}
  const rules=document.getElementById('rules').value; const chKey=chassisSel1.value;
  const top3=runSimulations(lastProfile,rules,chKey); renderTop3(top3,chKey);
};
function computeAdvice(p,rules,chKey){
  const picks=[];
  picks.push({cat:'plate',name:pick('plate','FRP Front'),pos:['F1','F2','F3']});
  picks.push({cat:'plate',name:pick('plate','Rear'),pos:['R1','R2','R3']});
  (p.curve_pct<0.35)
    ? picks.push({cat:'roller',name:pickName('roller','19mm'),pos:['F1','F2']})
    : picks.push({cat:'roller',name:pickName('roller','19mm'),pos:['F1','F2']},{cat:'roller',name:pickName('roller','13mm'),pos:['R1','R2']});
  const heavyRear = p.jumps>0 || p.banked>0 || p.slope_max>8;
  picks.push({cat:'damper',name:pickName('damper',heavyRear?'12g':'8g'),pos:['C3','C4']});
  if(heavyRear) picks.push({cat:'damper',name:pickName('damper','8g'),pos:['C1','C2']});
  picks.push({cat:'brake',name:pickName('brake',p.jumps>0?'1mm':'0.5mm'),pos:['R1','R2']});
  picks.push({cat:'weight',name:pick('weight','Ottone'),pos:['C2','C3']});
  const ratio = p.straight_pct>0.6 ? '3.5:1' : (p.curve_pct>0.5 ? '4:1' : '3.7:1');
  picks.push({cat:'gear',name:pickName('gear',ratio),pos:[]});
  picks.push({cat:'motor',name:pick('motor','Dash')||'Hyper‑Dash 3',pos:[]});
  picks.push({cat:'fastener',name:'Viti/Rondelle/Distanziali',pos:[]});
  return {chassis:CHASSIS[chKey].name, rules, items:picks};
}
function runSimulations(p){ const rollers=filterNames('roller',['19mm','13mm']), gears=filterNames('gear',['3.5:1','3.7:1','4:1']), brakes=filterNames('brake',['1mm','0.5mm']), dampers=filterNames('damper',['12g','8g']); const results=[]; for(const r of rollers) for(const g of gears) for(const b of brakes) for(const d of dampers){ const cfg={roller:r,gear:g,brake:b,damper:d}; const s=scoreConfig(cfg,p); results.push({cfg,score:s}); } results.sort((a,b)=>b.score-a.score); return results.slice(0,3); }
function scoreConfig(cfg,p){ let speed=100*(p.straight_pct+0.3)*(cfg.gear.includes('3.5')?1.05:cfg.gear.includes('3.7')?1.0:0.92); let corner=100*(1-p.straight_pct)*(cfg.roller.includes('13mm')?1.05:0.98); let stability=100*((cfg.damper.includes('12g')?1.05:1.0)-(cfg.brake.includes('0.5')&&p.jumps>0?0.04:0)); let penalty=0; if(p.slope_max>10&&cfg.brake.includes('0.5')) penalty+=6; if(p.jumps>2&&cfg.damper.includes('8g')) penalty+=5; return speed*0.45+corner*0.25+stability*0.30-penalty; }
function renderTop3(top3,chKey){ const ch=CHASSIS[chKey]; let html=`<b>Top‑3 setup</b> (chassis: ${ch.name})<br><br>`; top3.forEach((r,i)=>{ html+=`<b>#${i+1}</b> — Roller: ${r.cfg.roller}, Gear: ${r.cfg.gear}, Brake: ${r.cfg.brake}, Damper: ${r.cfg.damper} <span class="muted">(score ${r.score.toFixed(1)})</span><br>`; }); document.getElementById('advice').innerHTML=html; }
function pick(cat,hint){ const list=Object.keys(CATALOG[cat]||{}); return list.find(n=>n.includes(hint))||list[0]||''; }
function pickName(cat,hint){ const list=Object.keys(CATALOG[cat]||{}); return list.find(n=>n.toLowerCase().includes(hint.toLowerCase()))||list[0]||''; }
function filterNames(cat,hints){ const all=Object.keys(CATALOG[cat]||{}); const out=[]; for(const h of hints){ const f=all.find(n=>n.toLowerCase().includes(h.toLowerCase())); if(f) out.push(f);} return out.length?out:all.slice(0,2); }

/* ===== Builder (SVG + snap fori) ===== */
const stage=document.getElementById('stage'), Gshape=document.getElementById('shape'), Gholes=document.getElementById('holes'), Gallowed=document.getElementById('allowed'), Gparts=document.getElementById('parts');
let mode='place', selected=null;
document.getElementById('place').onclick=()=>setMode('place'); document.getElementById('move').onclick=()=>setMode('move'); document.getElementById('del').onclick=()=>setMode('del'); document.getElementById('reset').onclick=()=>{Gparts.innerHTML='';};
function setMode(m){mode=m; document.querySelectorAll('#builder .chip').forEach(b=>b.classList.remove('active')); document.getElementById(m).classList.add('active');}
document.getElementById('chassis').onchange=renderBuilder; document.getElementById('view').onchange=renderBuilder;
function renderBuilder(){ const key=document.getElementById('chassis').value||Object.keys(CHASSIS)[0]; const view=document.getElementById('view').value||'top'; drawOutline(key,view); fillComp(); }
function drawOutline(key,view){ Gshape.innerHTML=''; Gholes.innerHTML=''; Gallowed.innerHTML=''; const ch=CHASSIS[key], o=ch.outline[view]||ch.outline.top; if(o.type==='path') Gshape.appendChild(svgEl('path',{d:o.d,fill:'var(--chassis)',stroke:'#7aa0ff','stroke-width':.8})); if(o.type==='rect') Gshape.appendChild(svgEl('rect',{x:o.x,y:o.y,width:o.w,height:o.h,rx:o.rx||0,fill:'var(--chassis)',stroke:'#7aa0ff','stroke-width':.8})); (ch.holes[view]||ch.holes.top).forEach(h=>{ const c=svgEl('circle',{cx:h.x,cy:h.y,r:1.7,class:'hole'}); c.dataset.hole=h.id; Gholes.appendChild(c); }); }
function svgEl(tag,attrs){ const e=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs) e.setAttribute(k,attrs[k]); return e; }
stage.addEventListener('click',(e)=>{ const hole=e.target.closest('circle.hole'); const pn=e.target.closest('g[data-part]'); if(mode==='place'){ if(!hole) return; const cat=catSel.value, name=compSel.value; const spec=CATALOG[cat]?.[name]; if(!spec) return; const g=drawPart(name,cat,spec.draw); g.setAttribute('transform',`translate(${hole.getAttribute('cx')} ${hole.getAttribute('cy')})`); Gparts.appendChild(g);} else if(mode==='move'){ selected=pn||null;} else if(mode==='del'){ if(pn) pn.remove(); } });
stage.addEventListener('mousemove',(e)=>{ if(mode!=='move'||!selected) return; const hole=e.target.closest('circle.hole'); if(hole) selected.setAttribute('transform',`translate(${hole.getAttribute('cx')} ${hole.getAttribute('cy')})`); });
window.addEventListener('keydown',e=>{ if((e.key==='Backspace'||e.key==='Delete')&&selected){ selected.remove(); selected=null; }});
function drawPart(name,cat,d){ const g=svgEl('g',{'data-part':name,'data-cat':cat}); if(!d) return g; if(d.type==='circle') g.appendChild(svgEl('circle',{r:d.r,fill:d.fill})); if(d.type==='rect') g.appendChild(svgEl('rect',{x:-d.w/2,y:-d.h/2,width:d.w,height:d.h,rx:d.rx||0,fill:d.fill})); return g; }

/* ===== Catalogo render ===== */
function renderCatalog(){ const box=document.getElementById('catList'); let html=''; for(const cat of Object.keys(CATALOG)){ html+=`<b>${cat}</b><br>`; for(const name of Object.keys(CATALOG[cat])){ const it=CATALOG[cat][name]; html+=`&nbsp;• ${name}${it.code?` <span class="muted">[ITEM ${it.code}]</span>`:''}<br>`; } html+='<br>'; } box.innerHTML=html; }

/* ===== PDF (se disponibile jsPDF via browser) ===== */
document.getElementById('pdf').onclick=()=>{
  if(!(window.jspdf&&window.jspdf.jsPDF)){ alert('PDF non disponibile in questa build senza librerie. Usa stampa → “Salva in PDF”.'); return; }
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'mm',format:'a4'});
  doc.setFontSize(14); doc.text('Mini4WD Advisor — Report pista',14,16);
  doc.setFontSize(10); doc.text(document.getElementById('profile').innerText.replace(/\n/g,'  '),14,26,{maxWidth:180});
  const img=cMain.toDataURL('image/png'); doc.addImage(img,'PNG',14,60,180,90);
  const adv=document.getElementById('advice').innerText.split('\n').join('  ');
  doc.text('Setup consigliato / Top‑3:',14,158); doc.text(adv||'—',14,166,{maxWidth:180});
  doc.save('mini4wd_report.pdf');
};

/* ===== Boot ===== */
function boot(){ fillSelectors(); renderBuilder(); renderCatalog(); }
boot();
</script>
</body>
</html>
