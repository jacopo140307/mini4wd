<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini4WD Advisor — Analyzer • Builder • Setup (B‑MAX / TMEC)</title>

<!-- Librerie -->
<link rel="preconnect" href="https://docs.opencv.org" />
<script src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --ink:#e6eeff; --muted:#9fb3ff; --line:#223258;
    --accent:#22d3ee; --chassis:#203a65; --hole:#93c5fd; --allowed:#22d3ee;
    --plate:#38bdf8; --roller:#22e3ab; --damper:#ffd166; --brake:#ff5370; --weight:#b8ff5a; --fastener:#cfd8dc;
  }
  html,body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1e);color:var(--ink);font-family:Inter,system-ui,-apple-system}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  h1{margin:6px 0 10px;font-size:clamp(22px,3vw,30px)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px}
  .panel h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--line);font-size:16px}
  .panel .body{padding:12px 16px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){.g2{grid-template-columns:420px 1fr}}
  select,input,button{border-radius:10px;border:1px solid var(--line);background:#0d1530;color:#e6eeff;padding:8px 10px}
  button.primary{background:linear-gradient(90deg,#7c3aed,#22d3ee);border:0}
  .muted{color:var(--muted);font-size:12px}
  .tabs{display:flex;gap:8px;margin:8px 0}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:#0d1530}
  .tab.active{border-color:var(--accent)}
  canvas,svg{width:100%;height:auto;border:1px solid var(--line);border-radius:14px;background:#0a0f1e}
  .hole{fill:var(--hole);stroke:#89c2ff;stroke-width:.35}
  .allowed{fill:none;stroke:var(--allowed);stroke-dasharray:2 2;stroke-width:.6;opacity:.7}
  .chip{border:1px solid var(--line);background:#0d1530;padding:7px 10px;border-radius:10px;cursor:pointer}
  .chip.active{border-color:#22d3ee;box-shadow:0 0 0 2px rgba(34,211,238,.15) inset}
  .badge{display:inline-block;padding:2px 6px;border-radius:8px;font-size:11px;margin-left:6px}
  .bmax{background:#0b3b2a;color:#b9ffd6} .tmec{background:#3b1a0b;color:#ffd6b9}
  .list{font-size:14px;line-height:1.6}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h1>Mini4WD Advisor — Analyzer • Builder • Setup <span class="badge bmax">B‑MAX</span> <span class="badge tmec">TMEC</span></h1>
    <div class="muted">Accesso locale: <span id="who">ospite</span></div>
  </div>

  <!-- Login locale -->
  <div class="panel" id="auth">
    <h2>Accesso</h2>
    <div class="body row" style="gap:8px">
      <input id="u" placeholder="Username" />
      <input id="p" placeholder="Password" type="password" />
      <button id="login">Entra</button>
      <button id="logout" style="display:none">Logout</button>
      <div class="muted">Credenziali salvate in locale sul dispositivo.</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="analyzer">Analisi Pista</div>
    <div class="tab" data-tab="advisor">Consigli & Simulazioni</div>
    <div class="tab" data-tab="builder">Layout Builder</div>
    <div class="tab" data-tab="catalog">Catalogo Tamiya</div>
  </div>

  <!-- 1) ANALYZER -->
  <div class="panel" id="analyzer">
    <h2>Analizzatore Pista (foto → profilo ML/fisica)</h2>
    <div class="body grid g2">
      <div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <label>Regolamento
            <select id="rules"><option>B-MAX</option><option>TMEC</option></select>
          </label>
          <label>Chassis
            <select id="chassisSel"></select>
          </label>
        </div>
        <div class="row" style="margin-top:8px;gap:8px">
          <input id="imgs" type="file" accept="image/*" multiple />
          <button id="run" class="primary">Analizza</button>
          <button id="loadML">Carica Modello ML</button>
          <button id="pdf">PDF</button>
        </div>
        <p class="muted">Carica 1–6 foto (anche sezioni). Senza ML usa il fallback fisica+geometria con filtro colore e contorni.</p>
        <div class="list" id="profile"></div>
      </div>
      <div><canvas id="canvasMain" width="960" height="540"></canvas></div>
    </div>
  </div>

  <!-- 2) ADVISOR -->
  <div class="panel" id="advisor" style="display:none">
    <h2>Consigli & Simulazioni (Top‑3)</h2>
    <div class="body grid g2">
      <div>
        <div class="row" style="gap:8px;margin-bottom:8px">
          <button id="simulate" class="primary">Esegui Simulazione</button>
          <span class="muted">Usa profilo pista corrente + regole.</span>
        </div>
        <div class="list" id="advice"></div>
      </div>
      <div>
        <canvas id="canvasAdvice" width="960" height="540"></canvas>
        <div class="muted" style="margin-top:6px">Roller/freni/damper/pesi visualizzati in mm sul telaio selezionato.</div>
      </div>
    </div>
  </div>

  <!-- 3) BUILDER -->
  <div class="panel" id="builder" style="display:none">
    <h2>Layout Builder (snap fori, viste reali)</h2>
    <div class="body grid g2">
      <div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <label>Vista
            <select id="view">
              <option value="top">Sopra</option><option value="bottom">Sotto</option>
              <option value="left">Lato sinistro</option><option value="right">Lato destro</option>
              <option value="front">Fronte</option><option value="rear">Retro</option>
              <option value="iso">Isometrica</option>
            </select>
          </label>
          <label>Chassis
            <select id="chassis"></select>
          </label>
          <label>Categoria
            <select id="cat"></select>
          </label>
          <label>Componente
            <select id="comp"></select>
          </label>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="place" class="chip">Aggancia</button>
          <button id="move" class="chip">Sposta</button>
          <button id="del" class="chip">Rimuovi</button>
          <button id="reset">Reset</button>
          <button id="exportLayout" class="primary">Export layout JSON</button>
        </div>
        <div class="panel" style="margin-top:12px">
          <h2>Chassis Digitizer (fori reali Tamiya)</h2>
          <div class="body">
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <input id="chImg" type="file" accept="image/*" />
              <button id="detectHoles">Rileva Fori</button>
              <button id="saveChassis" class="primary">Salva Telaio</button>
            </div>
            <div class="muted">Carica immagine ufficiale del telaio (top/bottom). Rilevazione fori + calibrazione mm (passo ruote = 80 mm).</div>
          </div>
        </div>
      </div>
      <div>
        <svg id="stage" viewBox="-110 -80 220 160" xmlns="http://www.w3.org/2000/svg" aria-label="Mini4WD Workspace">
          <defs><pattern id="mm" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M10 0H0V10" fill="none" stroke="#213050" stroke-width="0.25"/></pattern></defs>
          <rect x="-110" y="-80" width="220" height="160" fill="url(#mm)"/>
          <g id="shape"></g><g id="allowed"></g><g id="holes"></g><g id="parts"></g>
        </svg>
        <div class="muted" style="margin-top:6px">Coordinate SVG = mm (dopo calibrazione).</div>
      </div>
    </div>
  </div>

  <!-- 4) CATALOGO -->
  <div class="panel" id="catalog" style="display:none">
    <h2>Catalogo Tamiya • <span id="src" class="muted">cache locale</span></h2>
    <div class="body">
      <div class="row" style="gap:8px;margin-bottom:8px">
        <button id="useLocal" class="primary">Usa cache locale</button>
      </div>
      <div id="catList" class="list"></div>
      <div class="muted">Questa build funziona offline con cache minima. Per il catalogo completo “solo Tamiya” si collega un micro‑proxy CORS alle pagine ufficiali.</div>
    </div>
  </div>
</div>

<script>
/* ===== Accesso locale ===== */
const who=document.getElementById('who');
const u=document.getElementById('u'), p=document.getElementById('p'), logout=document.getElementById('logout');
document.getElementById('login').onclick=()=>{ localStorage.setItem('m4_user',u.value); localStorage.setItem('m4_pass',p.value); who.textContent=u.value||'ospite'; logout.style.display='inline-block'; };
document.getElementById('logout').onclick=()=>{ localStorage.removeItem('m4_user'); localStorage.removeItem('m4_pass'); who.textContent='ospite'; logout.style.display='none'; };
(function(){const name=localStorage.getItem('m4_user'); if(name){ who.textContent=name; logout.style.display='inline-block'; }})();

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    ['analyzer','advisor','builder','catalog'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById(t.dataset.tab).style.display='';
  };
});

/* ===== Dataset telai (fori + sagome semplificate ma coerenti in mm) ===== */
const CHASSIS = {
  SUPER2: mkChassis('Super‑II', {
    topOutline: {type:'path', d:'M -70,-30 L -78,0 L -70,30 L 70,30 L 78,0 L 70,-30 Z'},
    holesTop:[{id:'F1',x:-84,y:-10},{id:'F2',x:-84,y:10},{id:'F3',x:-72,y:0},{id:'C1',x:-20,y:-12},{id:'C2',x:-20,y:12},{id:'C3',x:20,y:-12},{id:'C4',x:20,y:12},{id:'R1',x:84,y:-10},{id:'R2',x:84,y:10},{id:'R3',x:72,y:0}]
  }),
  MA: mkChassis('MA', {
    topOutline: {type:'path', d:'M -68,-28 L -76,0 L -68,28 L 68,28 L 76,0 L 68,-28 Z'},
    holesTop:[{id:'F1',x:-82,y:-10},{id:'F2',x:-82,y:10},{id:'F3',x:-70,y:0},{id:'C1',x:-18,y:-12},{id:'C2',x:-18,y:12},{id:'C3',x:18,y:-12},{id:'C4',x:18,y:12},{id:'R1',x:82,y:-10},{id:'R2',x:82,y:10},{id:'R3',x:70,y:0}]
  }),
  MS: mkChassis('MS', {
    topOutline: {type:'path', d:'M -66,-26 L -74,0 L -66,26 L 66,26 L 74,0 L 66,-26 Z'},
    holesTop:[{id:'F1',x:-80,y:-10},{id:'F2',x:-80,y:10},{id:'F3',x:-68,y:0},{id:'C1',x:-16,y:-11},{id:'C2',x:-16,y:11},{id:'C3',x:16,y:-11},{id:'C4',x:16,y:11},{id:'R1',x:80,y:-10},{id:'R2',x:80,y:10},{id:'R3',x:68,y:0}]
  }),
  AR: mkChassis('AR', {
    topOutline: {type:'path', d:'M -69,-28 L -77,0 L -69,28 L 69,28 L 77,0 L 69,-28 Z'},
    holesTop:[{id:'F1',x:-83,y:-10},{id:'F2',x:-83,y:10},{id:'F3',x:-71,y:0},{id:'C1',x:-19,y:-12},{id:'C2',x:-19,y:12},{id:'C3',x:19,y:-12},{id:'C4',x:19,y:12},{id:'R1',x:83,y:-10},{id:'R2',x:83,y:10},{id:'R3',x:71,y:0}]
  }),
  VS: mkChassis('VS', {
    topOutline: {type:'path', d:'M -64,-24 L -72,0 L -64,24 L 64,24 L 72,0 L 64,-24 Z'},
    holesTop:[{id:'F1',x:-78,y:-9},{id:'F2',x:-78,y:9},{id:'F3',x:-66,y:0},{id:'C1',x:-16,y:-10},{id:'C2',x:-16,y:10},{id:'C3',x:16,y:-10},{id:'C4',x:16,y:10},{id:'R1',x:78,y:-9},{id:'R2',x:78,y:9},{id:'R3',x:66,y:0}]
  }),
  VZ: mkChassis('VZ', {
    topOutline: {type:'path', d:'M -66,-26 L -74,0 L -66,26 L 66,26 L 74,0 L 66,-26 Z'},
    holesTop:[{id:'F1',x:-84,y:-10},{id:'F2',x:-84,y:10},{id:'F3',x:-72,y:0},{id:'C1',x:-18,y:-12},{id:'C2',x:-18,y:12},{id:'C3',x:18,y:-12},{id:'C4',x:18,y:12},{id:'R1',x:84,y:-10},{id:'R2',x:84,y:10},{id:'R3',x:72,y:0}]
  }),
  FM_A: mkChassis('FM‑A', {
    topOutline: {type:'path', d:'M -66,-26 L -74,0 L -66,26 L 66,26 L 74,0 L 66,-26 Z'},
    holesTop:[{id:'F1',x:-82,y:-10},{id:'F2',x:-82,y:10},{id:'F3',x:-70,y:0},{id:'C1',x:-18,y:-12},{id:'C2',x:-18,y:12},{id:'C3',x:18,y:-12},{id:'C4',x:18,y:12},{id:'R1',x:82,y:-10},{id:'R2',x:82,y:10},{id:'R3',x:70,y:0}]
  }),
  SUPERXX: mkChassis('Super‑XX', {
    topOutline: {type:'path', d:'M -72,-30 L -80,0 L -72,30 L 72,30 L 80,0 L 72,-30 Z'},
    holesTop:[{id:'F1',x:-88,y:-10},{id:'F2',x:-88,y:10},{id:'F3',x:-76,y:0},{id:'C1',x:-22,y:-12},{id:'C2',x:-22,y:12},{id:'C3',x:22,y:-12},{id:'C4',x:22,y:12},{id:'R1',x:88,y:-10},{id:'R2',x:88,y:10},{id:'R3',x:76,y:0}]
  })
};
function mkChassis(name,s){ return { name, outline:{ top:s.topOutline,bottom:s.topOutline,left:{type:'rect',x:-78,y:-18,w:156,h:36,rx:8},right:{type:'rect',x:-78,y:-18,w:156,h:36,rx:8},front:{type:'rect',x:-45,y:-20,w:90,h:40,rx:8},rear:{type:'rect',x:-45,y:-20,w:90,h:40,rx:8},iso:s.topOutline }, holes:{top:s.holesTop,bottom:s.holesTop}, allowed:{top:[],bottom:[]} }; }

/* ===== Catalogo (cache minima) ===== */
let CATALOG={
  roller:{ "Roller 19mm Alluminio (ITEM 15459)":{code:"15459",mass:3.2,draw:{type:"circle",r:9.5,fill:"var(--roller)"}}, "Roller 13mm Alluminio (ITEM 15413)":{code:"15413",mass:1.9,draw:{type:"circle",r:6.5,fill:"var(--roller)"}} },
  plate:{ "FRP Front Wide (ITEM 15430)":{code:"15430",mass:6.8,draw:{type:"rect",w:60,h:10,rx:4,fill:"var(--plate)"}}, "FRP Rear Multi (ITEM 15518)":{code:"15518",mass:7.2,draw:{type:"rect",w:60,h:10,rx:4,fill:"var(--plate)"}} },
  damper:{ "Mass Damper 12g (ITEM 15441)":{code:"15441",mass:12,draw:{type:"circle",r:6,fill:"var(--damper)"}}, "Mass Damper 8g (ITEM 15440)":{code:"15440",mass:8,draw:{type:"circle",r:5.2,fill:"var(--damper)"}} },
  brake:{ "Sponge Brake 1mm (ITEM 15423)":{code:"15423",mass:1.5,draw:{type:"rect",w:32,h:3,rx:1.5,fill:"var(--brake)"}}, "Sponge Brake 0.5mm (ITEM 15422)":{code:"15422",mass:1.0,draw:{type:"rect",w:32,h:3,rx:1.5,fill:"var(--brake)"}} },
  weight:{ "Ottone 6x12 (ITEM 15524)":{code:"15524",mass:3.0,draw:{type:"rect",w:12,h:4,rx:1.2,fill:"var(--weight)"}} },
  gear:{ "3.5:1 High-Speed (ITEM 15349)":{code:"15349",mass:1.2,draw:{type:"circle",r:7,fill:"#ffe08a"}}, "4:1 High-Speed (ITEM 15355)":{code:"15355",mass:1.2,draw:{type:"circle",r:7,fill:"#ffe08a"}} },
  motor:{ "Hyper‑Dash 3":{code:"",mass:17,draw:{type:"rect",w:12,h:8,rx:1.4,fill:"#8ab4f8"}} },
  fastener:{ "Vite 2x8":{code:"",mass:0.2,draw:{type:"rect",w:2,h:8,rx:.5,fill:"var(--fastener)"}}, "Rondella 2mm":{code:"",mass:0.05,draw:{type:"circle",r:1.5,fill:"var(--fastener)"}}, "Distanziale 2x5":{code:"",mass:0.1,draw:{type:"rect",w:5,h:2,rx:.5,fill:"var(--fastener)"}} }
};

/* ===== Riempimento selettori ===== */
const chassisSel1=document.getElementById('chassisSel'), chassisSel2=document.getElementById('chassis');
const catSel=document.getElementById('cat'), compSel=document.getElementById('comp');
function fillSelectors(){ const keys=Object.keys(CHASSIS); chassisSel1.innerHTML=keys.map(k=>`<option value="${k}">${CHASSIS[k].name}</option>`).join(''); chassisSel2.innerHTML=keys.map(k=>`<option value="${k}">${CHASSIS[k].name}</option>`).join(''); const cats=Object.keys(CATALOG); catSel.innerHTML=cats.map(k=>`<option value="${k}">${k}</option>`).join(''); fillComp(); }
function fillComp(){ const cat=catSel.value; const list=Object.keys(CATALOG[cat]||{}); compSel.innerHTML=list.map(n=>`<option>${n}</option>`).join(''); }

/* ===== OpenCV ready (safe) ===== */
function cvReady(){ return new Promise(res=>{ const tryInit=()=>{ const lib=window.cv; if(lib&&lib.Mat){res();return;} if(lib&&lib['onRuntimeInitialized']){lib['onRuntimeInitialized']=()=>res();return;} setTimeout(tryInit,50); }; tryInit(); }); }

/* ===== ANALYZER (color+contour, ML opzionale) ===== */
const canvasMain=document.getElementById('canvasMain'); const ctxMain=canvasMain.getContext('2d');
document.getElementById('loadML').onclick=async()=>{ const url=prompt('URL modello TF.js (model.json)'); if(!url) return; try{ window._m4_net=await tf.loadGraphModel(url); alert('Modello ML caricato ✔'); }catch(e){ alert('Errore modello: '+e.message); } };
document.getElementById('run').onclick=analyze;

async function analyze(){
  const files=[...document.getElementById('imgs').files]; if(!files.length){ alert('Carica almeno una foto.'); return; }
  await cvReady(); const cvlib=window.cv;
  const img=await fileToImg(files[0]); let src=cvlib.imread(img);
  const scale=Math.min(1,1280/Math.max(src.cols,src.rows)); if(scale<1){ let d=new cvlib.Mat(); cvlib.resize(src,d,new cvlib.Size(0,0),scale,scale,cvlib.INTER_AREA); src.delete(); src=d; }

  const mask=maskTrackColor(cvlib,src);
  const kernel=cvlib.getStructuringElement(cvlib.MORPH_RECT,new cvlib.Size(7,7));
  cvlib.morphologyEx(mask,mask,cvlib.MORPH_CLOSE,kernel,new cvlib.Point(-1,-1),2);

  const cnts=new cvlib.MatVector(), hier=new cvlib.Mat();
  cvlib.findContours(mask,cnts,hier,cvlib.RETR_EXTERNAL,cvlib.CHAIN_APPROX_NONE);
  let maxA=0,best=null; for(let i=0;i<cnts.size();i++){ const a=cvlib.contourArea(cnts.get(i)); if(a>maxA){maxA=a; best=cnts.get(i);} }

  const vis=new cvlib.Mat(); cvlib.cvtColor(mask,vis,cvlib.COLOR_GRAY2RGBA); if(best){ cvlib.drawContours(vis,new cvlib.MatVector(best),-1,new cvlib.Scalar(255,120,0,255),2); }
  cvlib.imshow('canvasMain',vis);

  let prof = best ? profileFromContour(cvlib,best,src) : fallbackProfile(cvlib,src);
  if(window._m4_net){ const id=ctxMain.getImageData(0,0,canvasMain.width,canvasMain.height); const ml=mlProfileFromImage(id); for(const k of ['length_m','straight_pct','curve_pct','tight_curves','jumps','banked','slope_max']) if(typeof prof[k]==='number'&&typeof ml[k]==='number') prof[k]=0.6*prof[k]+0.4*ml[k]; }
  showProfile(prof);
  renderAdvice(computeAdvice(prof, document.getElementById('rules').value, chassisSel1.value));

  src.delete(); mask.delete(); kernel.delete(); cnts.delete(); hier.delete(); vis.delete();
}
function fileToImg(file){ return new Promise(r=>{ const i=new Image(); i.onload=()=>r(i); i.src=URL.createObjectURL(file); }); }

function maskTrackColor(cvlib,src){
  let hsv=new cvlib.Mat(); cvlib.cvtColor(src,hsv,cvlib.COLOR_RGBA2RGB); cvlib.cvtColor(hsv,hsv,cvlib.COLOR_RGB2HSV);
  let low1=new cvlib.Mat(hsv.rows,hsv.cols,hsv.type(),[0,0,160,0]); let up1=new cvlib.Mat(hsv.rows,hsv.cols,hsv.type(),[179,60,255,0]); let m1=new cvlib.Mat(); cvlib.inRange(hsv,low1,up1,m1);
  let low2=new cvlib.Mat(hsv.rows,hsv.cols,hsv.type(),[0,0,120,0]); let up2=new cvlib.Mat(hsv.rows,hsv.cols,hsv.type(),[179,90,200,0]); let m2=new cvlib.Mat(); cvlib.inRange(hsv,low2,up2,m2);
  let gray=new cvlib.Mat(); cvlib.cvtColor(src,gray,cvlib.COLOR_RGBA2GRAY); let m3=new cvlib.Mat(); cvlib.threshold(gray,m3,220,255,cvlib.THRESH_BINARY);
  let mask=new cvlib.Mat(); cvlib.bitwise_or(m1,m2,mask); cvlib.bitwise_or(mask,m3,mask);
  hsv.delete(); low1.delete(); up1.delete(); m1.delete(); low2.delete(); up2.delete(); m2.delete(); gray.delete(); m3.delete();
  return mask;
}
function profileFromContour(cvlib,contour,src){
  const len=contour.total(); let length_m=Math.max(20,(len/100));
  let corners=0,straightScore=0,N=0; const step=Math.max(5,Math.round(len/600)); const pts=[];
  for(let i=0;i<len;i+=step){ const p=contour.intPtr(i); pts.push({x:p[0],y:p[1]}); }
  for(let i=2;i<pts.length;i++){ const a=Math.atan2(pts[i-1].y-pts[i-2].y,pts[i-1].x-pts[i-2].x); const b=Math.atan2(pts[i].y-pts[i-1].y,pts[i].x-pts[i-1].x); let d=Math.abs(a-b); if(d>Math.PI)d=2*Math.PI-d; if(d>0.20) corners++; else straightScore++; N++; }
  const curve_pct=Math.min(0.95,Math.max(0.05,corners/Math.max(1,N))); const straight_pct=1-curve_pct; const tight_curves=Math.round(corners/30);
  let jumps=0,banked=0,slope_max=6; let g=new cvlib.Mat(); cvlib.cvtColor(src,g,cvlib.COLOR_RGBA2GRAY); let bw=new cvlib.Mat(); cvlib.threshold(g,bw,235,255,cvlib.THRESH_BINARY);
  const cc=new cvlib.MatVector(),hh=new cvlib.Mat(); cvlib.findContours(bw,cc,hh,cvlib.RETR_EXTERNAL,cvlib.CHAIN_APPROX_SIMPLE);
  for(let i=0;i<cc.size();i++){ const r=cvlib.boundingRect(cc.get(i)); const ratio=r.width/r.height; if(r.width>80&&r.height>15&&ratio>3) jumps++; if(r.width>120&&r.height>25&&ratio>4){ banked++; slope_max=Math.max(slope_max,10); } }
  g.delete(); bw.delete(); cc.delete(); hh.delete();
  return { length_m, straight_pct, curve_pct, tight_curves, jumps, banked, slope_max, surface:'liscia' };
}
function fallbackProfile(cvlib,m){ let g=new cvlib.Mat(); cvlib.cvtColor(m,g,cvlib.COLOR_RGBA2GRAY); let b=new cvlib.Mat(); cvlib.GaussianBlur(g,b,new cvlib.Size(5,5),0); let e=new cvlib.Mat(); cvlib.Canny(b,e,80,160); let lines=new cvlib.Mat(); cvlib.HoughLinesP(e,lines,1,Math.PI/180,80,40,30); let straight=0,total=0; for(let i=0;i<lines.rows;i++){ const [x1,y1,x2,y2]=lines.data32S.slice(i*4,i*4+4); const L=Math.hypot(x2-x1,y2-y1); total+=L; if(Math.abs(Math.atan2(y2-y1,x2-x1))<0.35) straight+=L; } g.delete(); b.delete(); e.delete(); lines.delete(); const curve_pct=Math.max(0,1-straight/Math.max(1,total)); return { length_m:(total/100)*1.2, straight_pct:straight/Math.max(1,total), curve_pct, tight_curves:Math.round(curve_pct*8), jumps:0, banked:0, slope_max:(curve_pct>0.4?8:6), surface:'liscia' }; }
function mlProfileFromImage(imgData){ const net=window._m4_net; if(!net) return null; return tf.tidy(()=>{ const t=tf.browser.fromPixels(imgData).resizeBilinear([224,224]).toFloat().div(255).expandDims(0); const y=net.execute(t); const v=Array.from(y.dataSync()); y.dispose(); t.dispose(); return { length_m:Math.max(15,v[0]*120), straight_pct:Math.min(0.9,Math.max(0.1,v[1])), curve_pct:1-Math.min(0.9,Math.max(0.1,v[1])), tight_curves:Math.round(v[2]*8), jumps:Math.round(v[3]*6), banked:Math.round(v[4]*4), slope_max:(v[5]*15), surface:(v[6]>0.5?'liscia':'media') }; }); }
let lastProfile=null; function showProfile(p){ lastProfile=p; document.getElementById('profile').innerHTML=`<b>Lunghezza:</b> ${p.length_m.toFixed(1)} m<br><b>Rettifili:</b> ${(p.straight_pct*100|0)}% • <b>Curve:</b> ${(p.curve_pct*100|0)}% • <b>Curve strette:</b> ${p.tight_curves}<br><b>Salti:</b> ${p.jumps} • <b>Paraboliche:</b> ${p.banked} • <b>Pendenza max:</b> ${p.slope_max.toFixed(1)}°<br><b>Superficie:</b> ${p.surface}`; }

/* ===== Advisor & Sim ===== */
document.getElementById('simulate').onclick=()=>{ if(!lastProfile){ alert('Esegui prima l’Analisi Pista.'); return; } const rules=document.getElementById('rules').value; const chKey=chassisSel1.value; const top3=runSimulations(lastProfile,rules,chKey); renderTop3(top3,chKey); };
function computeAdvice(p,rules,chKey){ const picks=[]; picks.push({cat:'plate',name:pick('plate','FRP Front'),pos:['F1','F2','F3']}); picks.push({cat:'plate',name:pick('plate','Rear'),pos:['R1','R2','R3']}); (p.curve_pct<0.35)?picks.push({cat:'roller',name:pickName('roller','19mm'),pos:['F1','F2']}):picks.push({cat:'roller',name:pickName('roller','19mm'),pos:['F1','F2']},{cat:'roller',name:pickName('roller','13mm'),pos:['R1','R2']}); const heavyRear=p.jumps>0||p.banked>0||p.slope_max>8; picks.push({cat:'damper',name:pickName('damper',heavyRear?'12g':'8g'),pos:['C3','C4']}); if(heavyRear)picks.push({cat:'damper',name:pickName('damper','8g'),pos:['C1','C2']}); picks.push({cat:'brake',name:pickName('brake',p.jumps>0?'1mm':'0.5mm'),pos:['R1','R2']}); picks.push({cat:'weight',name:pick('weight','Ottone'),pos:['C2','C3']}); const ratio=p.straight_pct>0.6?'3.5:1':(p.curve_pct>0.5?'4:1':'3.7:1'); picks.push({cat:'gear',name:pickName('gear',ratio),pos:[]}); picks.push({cat:'motor',name:pick('motor','Dash')||'Hyper‑Dash 3',pos:[]}); picks.push({cat:'fastener',name:'Viti/Rondelle/Distanziali',pos:[]}); return {chassis:CHASSIS[chKey].name, rules, items:picks}; }
function renderAdvice(res){ const div=document.getElementById('advice'); const lines=res.items.map(it=>{ const code=CATALOG[it.cat]?.[it.name]?.code||''; const where=(it.pos||[]).join(', '); return `• <b>${it.name}</b> <span class="muted">[${it.cat}]</span>${code?` — <b>ITEM ${code}</b>`:''}${where?` — fori: ${where}`:''}`; }).join('<br>'); div.innerHTML=`<b>Chassis:</b> ${res.chassis} • <b>Regole:</b> ${res.rules}<br><br>${lines||'—'}`; drawAdvice(res); }
function runSimulations(p,rules,chKey){ const rollers=filterNames('roller',['19mm','13mm']), gears=filterNames('gear',['3.5:1','3.7:1','4:1']), brakes=filterNames('brake',['1mm','0.5mm']), dampers=filterNames('damper',['12g','8g']); const results=[]; for(const r of rollers){ for(const g of gears){ for(const b of brakes){ for(const d of dampers){ const cfg={roller:r,gear:g,brake:b,damper:d}; const s=scoreConfig(cfg,p); results.push({cfg,score:s}); }}}} results.sort((a,b)=>b.score-a.score); return results.slice(0,3); }
function scoreConfig(cfg,p){ let speed=100*(p.straight_pct+0.3)*(cfg.gear.includes('3.5')?1.05:cfg.gear.includes('3.7')?1.0:0.92); let corner=100*(1-p.straight_pct)*(cfg.roller.includes('13mm')?1.05:0.98); let stability=100*((cfg.damper.includes('12g')?1.05:1.0)-(cfg.brake.includes('0.5')&&p.jumps>0?0.04:0)); let penalty=0; if(p.slope_max>10&&cfg.brake.includes('0.5')) penalty+=6; if(p.jumps>2&&cfg.damper.includes('8g')) penalty+=5; return speed*0.45+corner*0.25+stability*0.30-penalty; }
function renderTop3(top3,chKey){ const ch=CHASSIS[chKey]; const advDiv=document.getElementById('advice'); let html=`<b>Top‑3 setup</b> (chassis: ${ch.name})<br><br>`; top3.forEach((r,i)=>{ html+=`<b>#${i+1}</b> — Roller: ${r.cfg.roller}, Gear: ${r.cfg.gear}, Brake: ${r.cfg.brake}, Damper: ${r.cfg.damper} <span class="muted">(score ${r.score.toFixed(1)})</span><br>`; }); advDiv.innerHTML=html; }
function pick(cat,hint){ const list=Object.keys(CATALOG[cat]||{}); return list.find(n=>n.includes(hint))||list[0]||''; }
function pickName(cat,hint){ const list=Object.keys(CATALOG[cat]||{}); return list.find(n=>n.toLowerCase().includes(hint.toLowerCase()))||list[0]||''; }
function filterNames(cat,hints){ const all=Object.keys(CATALOG[cat]||{}); const out=[]; for(const h of hints){ const f=all.find(n=>n.toLowerCase().includes(h.toLowerCase())); if(f) out.push(f); } return out.length?out:all.slice(0,2); }

/* ===== Builder ===== */
const stage=document.getElementById('stage'); const Gshape=document.getElementById('shape'), Gholes=document.getElementById('holes'), Gallowed=document.getElementById('allowed'), Gparts=document.getElementById('parts');
let mode='place', selected=null;
document.getElementById('place').onclick=()=>setMode('place'); document.getElementById('move').onclick=()=>setMode('move'); document.getElementById('del').onclick=()=>setMode('del'); document.getElementById('reset').onclick=()=>{ Gparts.innerHTML=''; };
function setMode(m){ mode=m; document.querySelectorAll('#builder .chip').forEach(b=>b.classList.remove('active')); document.getElementById(m).classList.add('active'); }
document.getElementById('chassis').onchange=renderBuilder; document.getElementById('view').onchange=renderBuilder;
function renderBuilder(){ const key=document.getElementById('chassis').value||Object.keys(CHASSIS)[0]; const view=document.getElementById('view').value||'top'; drawOutline(key,view); fillComp(); }
function drawOutline(key,view){ Gshape.innerHTML=''; Gholes.innerHTML=''; Gallowed.innerHTML=''; const ch=CHASSIS[key], o=ch.outline[view]||ch.outline.top; if(o?.type==='path') Gshape.appendChild(svgEl('path',{d:o.d,fill:'var(--chassis)',stroke:'#7aa0ff','stroke-width':.8})); if(o?.type==='rect') Gshape.appendChild(svgEl('rect',{x:o.x,y:o.y,width:o.w,height:o.h,rx:o.rx||0,fill:'var(--chassis)',stroke:'#7aa0ff','stroke-width':.8})); (ch.allowed?.[view]||[]).forEach(a=>{ if(a.type==='rect') Gallowed.appendChild(svgEl('rect',{x:a.x,y:a.y,width:a.w,height:a.h,class:'allowed'})); }); (ch.holes?.[view]||ch.holes?.top||[]).forEach(h=>{ const c=svgEl('circle',{cx:h.x,cy:h.y,r:1.7,class:'hole'}); c.dataset.hole=h.id||''; Gholes.appendChild(c); }); }
function svgEl(tag,attrs){ const e=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs) e.setAttribute(k,attrs[k]); return e; }
stage.addEventListener('click',(e)=>{ const hole=e.target.closest('circle.hole'); const pn=e.target.closest('g[data-part]'); if(mode==='place'){ if(!hole) return; const cat=catSel.value, name=compSel.value; const spec=CATALOG[cat]?.[name]; if(!spec) return; const g=drawPart(name,cat,spec.draw); g.setAttribute('transform',`translate(${hole.getAttribute('cx')} ${hole.getAttribute('cy')})`); Gparts.appendChild(g); } else if(mode==='move'){ selected=pn||null; } else if(mode==='del'){ if(pn) pn.remove(); } });
stage.addEventListener('mousemove',(e)=>{ if(mode!=='move'||!selected) return; const hole=e.target.closest('circle.hole'); if(hole) selected.setAttribute('transform',`translate(${hole.getAttribute('cx')} ${hole.getAttribute('cy')})`); });
window.addEventListener('keydown',e=>{ if((e.key==='Backspace'||e.key==='Delete')&&selected){ selected.remove(); selected=null; } });
function drawPart(name,cat,d){ const g=svgEl('g',{'data-part':name,'data-cat':cat}); if(!d) return g; if(d.type==='circle') g.appendChild(svgEl('circle',{r:d.r,fill:d.fill})); if(d.type==='rect') g.appendChild(svgEl('rect',{x:-d.w/2,y:-d.h/2,width:d.w,height:d.h,rx:d.rx||0,fill:d.fill})); return g; }

/* ===== Digitizer (opzionale) ===== */
document.getElementById('detectHoles').onclick=async()=>{ await cvReady(); const cvlib=window.cv; const f=document.getElementById('chImg').files[0]; if(!f){ alert('Scegli immagine telaio.'); return; } const img=await fileToImg(f); const src=cvlib.imread(img); const gray=new cvlib.Mat(); cvlib.cvtColor(src,gray,cvlib.COLOR_RGBA2GRAY,0); cvlib.GaussianBlur(gray,gray,new cvlib.Size(5,5),0); const circles=new cvlib.Mat(); cvlib.HoughCircles(gray,circles,cvlib.HOUGH_GRADIENT,1,40,120,30,10,80); let kmm=0.2; if(circles.rows>=2){ const c1=circles.data32F.slice(0,3), c2=circles.data32F.slice(3,6); const dpx=Math.hypot(c1[0]-c2[0],c1[1]-c2[1]); kmm=80/Math.max(1,dpx); } const rMin=Math.max(2,Math.round(1.0/kmm)), rMax=Math.max(rMin+2,Math.round(2.0/kmm)); const holes=new cvlib.Mat(); cvlib.HoughCircles(gray,holes,cvlib.HOUGH_GRADIENT,1,8,120,20,rMin,rMax); const cx=src.cols/2, cy=src.rows/2; const list=[]; for(let i=0;i<holes.rows;i++){ const [x,y]=holes.data32F.slice(i*3,i*3+3); list.push({id:'H'+(i+1),x:(x-cx)*kmm,y:(y-cy)*kmm}); } src.delete(); gray.delete(); circles.delete(); holes.delete(); window._lastHoles=list; alert(`Rilevati ${list.length} fori. Scala ≈ ${kmm.toFixed(3)} mm/px`); };
document.getElementById('saveChassis').onclick=()=>{ const list=window._lastHoles||[]; if(!list.length){ alert('Rileva prima i fori.'); return; } const name=prompt('Nome telaio (es. SUPER‑II Reale / MA / MS / AR / VS / VZ / FM‑A / XX):','SUPER‑II Reale'); if(!name) return; const key=name.toUpperCase().replace(/[^A-Z0-9]/g,'').replace('SUPERII','SUPER2'); CHASSIS[key]=CHASSIS[key]||{name, outline:CHASSIS.SUPER2.outline, holes:{top:[],bottom:[]}, allowed:{top:[],bottom:[]}}; CHASSIS[key].holes.top=list; fillSelectors(); chassisSel1.value=key; chassisSel2.value=key; renderBuilder(); alert('Telaio salvato ✔'); };

/* ===== Catalogo (render) ===== */
document.getElementById('useLocal').onclick=()=>{ renderCatalog(); };
function renderCatalog(){ const box=document.getElementById('catList'); let html=''; for(const cat of Object.keys(CATALOG)){ html+=`<b>${cat}</b><br>`; for(const name of Object.keys(CATALOG[cat])){ const it=CATALOG[cat][name]; html+=`&nbsp;• ${name}${it.code?` <span class="muted">[ITEM ${it.code}]</span>`:''}<br>`; } html+='<br>'; } box.innerHTML=html; }

/* ===== PDF ===== */
document.getElementById('pdf').onclick=()=>{ const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'mm',format:'a4'}); doc.setFontSize(14); doc.text('Mini4WD Advisor — Report pista',14,16); doc.setFontSize(10); doc.text(document.getElementById('profile').innerText.replace(/\n/g,'  '),14,26,{maxWidth:180});
