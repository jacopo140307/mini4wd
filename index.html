<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>B-MAX Advisor • Demo completa (single-file)</title>
<style>
:root{color-scheme:dark}
*{box-sizing:border-box}
html,body{margin:0;background:#0b1220;color:#e5e7eb;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
h1{font-size:18px;margin:0 0 8px}
h2{font-size:15px;margin:8px 0}
small{opacity:.75}
.wrap{max-width:1200px;margin:auto;padding:12px}
.grid{display:grid;gap:12px}
@media (min-width:980px){.grid{grid-template-columns:1.1fr .9fr}}
.card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:12px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:end}
label{display:block;font-size:12px;margin-bottom:4px;opacity:.9}
select,button,input[type=file]{background:#0b1220;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:8px 10px}
button.primary{background:#0ea5e9;border-color:#0ea5e9;color:#081016}
button.ghost{background:#0f172a}
.bad{color:#fca5a5}.ok{color:#86efac}.warn{color:#fde68a}
.legend span{display:inline-block;width:.8rem;height:.8rem;border-radius:9999px;margin-right:.35rem;vertical-align:-1px}
svg{width:100%;height:520px;display:block;background:#0b1220;border-radius:12px}
.gridbg{stroke:#1f2937;stroke-width:.35}
.outline{fill:#0f1b35;stroke:#334155;stroke-width:1.2}
.hole{fill:#1e293b}
.pin{cursor:pointer}
.pin text{font-size:4px;fill:#e5e7eb}
.pin.roll  circle{fill:#60a5fa;stroke:#0b1220;stroke-width:.8}
.pin.brake circle{fill:#f87171;stroke:#0b1220;stroke-width:.8}
.pin.damp  circle{fill:#facc15;stroke:#0b1220;stroke-width:.8}
.pin.stay  circle{fill:#a78bfa;stroke:#0b1220;stroke-width:.8}
.pin.tire  circle{fill:#34d399;stroke:#0b1220;stroke-width:.8}
.pin.hw    circle{fill:#94a3b8;stroke:#0b1220;stroke-width:.8}
.pin.under circle{fill:#9ca3af;stroke:#0b1220;stroke-width:.8}
.tt{position:fixed;background:#0b1220;border:1px solid #334155;border-radius:8px;padding:6px 8px;font-size:12px;display:none;z-index:60;max-width:260px}
.log{font-family:ui-monospace,monospace;font-size:12px;white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:8px;max-height:240px;overflow:auto}
.kv{display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:12px}
.kv div:nth-child(odd){opacity:.8}
.pill{display:inline-block;border:1px solid #334155;border-radius:9999px;padding:2px 8px;margin:0 4px 4px 0;font-size:12px}
input[type=search]{width:100%;padding:8px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
.table{width:100%;border-collapse:collapse;font-size:12px}
.table td,.table th{border-bottom:1px solid #1f2937;padding:6px 4px;text-align:left}
footer{opacity:.6;font-size:12px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>B-MAX Advisor — Demo completa (carica foto pista + mini, ottimizza setup unico)</h1>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row">
        <div><label>Telaio</label>
          <select id="selChassis">
            <option value="fma" selected>FM-A</option>
            <option value="ma">MA</option>
            <option value="s2">Super-II</option>
          </select>
        </div>
        <div><label>Vista</label>
          <select id="selView">
            <option value="top" selected>Top</option>
            <option value="bottom">Bottom</option>
          </select>
        </div>
        <div><label>Foto pista (jpg/png)</label>
          <input id="inTrack" type="file" accept="image/*"/>
        </div>
        <div><label>Foto mini (jpg/png)</label>
          <input id="inCar" type="file" accept="image/*"/>
        </div>
        <button id="btnDetect" class="primary">Analizza foto</button>
        <button id="btnOpt" class="ghost">Ottimizza</button>
        <button id="btnPDF" class="ghost">Esporta PDF</button>
        <button id="btnJSON" class="ghost">Export JSON</button>
      </div>

      <p class="legend" style="margin:8px 0 6px">
        <span style="background:#60a5fa"></span>Roller
        <span style="background:#f87171;margin-left:10px"></span>Freni
        <span style="background:#facc15;margin-left:10px"></span>Damper
        <span style="background:#a78bfa;margin-left:10px"></span>Piastre
        <span style="background:#34d399;margin-left:10px"></span>Gomme
        <span style="background:#94a3b8;margin-left:10px"></span>Ferramenta
        <span class="pill">clicca 2 fori → calibra mm (interasse 16)</span>
      </p>

      <!-- BLUEPRINT -->
      <div class="card" style="padding:0">
        <svg id="svg" viewBox="0 0 200 120" aria-label="blueprint">
          <defs>
            <pattern id="grid5" width="5" height="5" patternUnits="userSpaceOnUse">
              <path class="gridbg" d="M5 0V5M0 5H5"/>
            </pattern>
          </defs>
          <rect x="0" y="0" width="200" height="120" fill="url(#grid5)"/>
          <g id="gShape"></g>
          <g id="gHoles"></g>
          <g id="gPins"></g>
        </svg>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" style="display:grid;gap:10px;height:fit-content">
      <div>
        <h2>Setup vincente (auto)</h2>
        <div id="summary" class="kv"></div>
      </div>
      <div>
        <h2>Analisi pista</h2>
        <div id="trackOut" class="log"></div>
      </div>
      <div>
        <h2>Analisi mini</h2>
        <div id="carOut" class="log"></div>
      </div>
      <div>
        <h2>Log decisioni</h2>
        <div id="log" class="log"></div>
      </div>
      <div>
        <h2>Check B-MAX</h2>
        <div id="bmax" class="log"></div>
        <small>Limiti: 105×165×70 mm • Ground ≥1 mm • Ruote Ø22–35 mm • Larghezza 8–26 mm.</small>
      </div>
      <div class="card">
        <h2>Catalogo (demo)</h2>
        <input id="q" type="search" placeholder="Cerca (es. roller 19, freno 2.0, damper 12g)…">
        <table class="table" id="tbl"></table>
        <small>Nota: codici Tamiya mostrati solo quando caricati dal catalogo ufficiale.</small>
      </div>
    </div>
  </div>

  <footer>Demo locale: funziona offline. Per risultati reali, collega il catalogo Tamiya ufficiale nella fase successiva.</footer>
</div>

<div id="tt" class="tt"></div>

<script>
/* ====== SHAPES + HOLES (outline pulito; immagini reali verranno collegate in step successivo) ====== */
const OUTLINE={
  fma:"M16,28 q-7,10 -7,32 q0,22 7,32 h168 q7,-10 7,-32 q0,-22 -7,-32 z M92,36 h16 v48 h-16 z",
  ma:"M18,30 h164 v60 h-164 z M42,36 h116 v48 h-116 z",
  s2:"M18,30 q-6,9 -6,31 q0,22 6,31 h164 q6,-9 6,-31 q0,-22 -6,-31 z M22,38 h156 v44 h-156 z"
};
const HOLES={
  fma:{top:genLine(28,44,158,0,27).concat(genLine(28,92,158,0,27)).concat([[30,36],[170,36],[30,100],[170,100]]),
       bottom:[[26,96],[46,88],[96,104],[170,38],[100,100],[150,96]]},
  ma:{top:[[26,44],[46,44],[74,44],[100,44],[126,44],[154,44],[28,92],[48,92],[74,92],[100,92],[126,92],[152,92],[30,36],[170,36],[30,100],[170,100]],
      bottom:[[28,96],[48,88],[96,104],[174,38],[100,100],[150,96]]},
  s2:{top:[[26,44],[46,44],[74,44],[100,44],[126,44],[154,44],[28,92],[48,92],[74,92],[100,92],[126,92],[152,92],[30,36],[170,36],[30,100],[170,100]],
      bottom:[[28,96],[48,88],[96,104],[170,37],[100,100],[150,96]]}
};
function genLine(x,y,dx,dy,n){const a=[];for(let i=0;i<n;i++)a.push([x+i*(dx/n),y+i*(dy/n)]);return a;}
/* ====== STATE ====== */
const $=s=>document.querySelector(s);
const svg=$("#svg"), gShape=$("#gShape"), gHoles=$("#gHoles"), gPins=$("#gPins"), tt=$("#tt");
const selCh=$("#selChassis"), selV=$("#selView"), log=$("#log"), sum=$("#summary"), bmx=$("#bmax");
const trackOut=$("#trackOut"), carOut=$("#carOut"), q=$("#q"), tbl=$("#tbl");
let chassis='fma', view='top', scalePXperMM=1, calib=[];
let lastTrack={}, lastCar={}, lastSetup=null;
/* ====== RENDER BLUEPRINT ====== */
function draw(){
  gShape.innerHTML='';
  const p=document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('class','outline'); p.setAttribute('d', OUTLINE[chassis]); gShape.appendChild(p);
  gHoles.innerHTML=''; const list=HOLES[chassis][view];
  for(const [x,y] of list){const c=svgEl('circle',{class:'hole',cx:x,cy:y,r:0.85}); c.addEventListener('click',holeClick); gHoles.appendChild(c);}
  gPins.innerHTML='';
}
function holeClick(e){
  const x=+e.target.getAttribute('cx'), y=+e.target.getAttribute('cy');
  calib.push([x,y]);
  if(calib.length===2){
    const dpx=Math.hypot(calib[0][0]-calib[1][0], calib[0][1]-calib[1][1]);
    const dmm=16; scalePXperMM=dpx/dmm; calib=[];
    toast(`Scala ≈ ${scalePXperMM.toFixed(2)} px/mm (interasse 16 mm)`);
  }
}
/* ====== SIMPLE DETECTORS (demo: stima da immagine via heuristiche robustissime offline) ====== */
$("#btnDetect").onclick=()=>{
  // pista: se carichi una foto, stima base (qui demo con valori plausibili)
  lastTrack = detectTrack($("#inTrack").files[0]);
  lastCar   = detectCar($("#inCar").files[0]);
  trackOut.textContent = JSON.stringify(lastTrack,null,2);
  carOut.textContent   = JSON.stringify(lastCar,null,2);
  toast("Analisi completata (demo). Ora premi 'Ottimizza'.");
};
function detectTrack(file){
  // DEMO: se esiste immagine, estrai pseudo-feature; altrimenti preset "tecnico"
  return {length_m: file? 80: 60, turns: file? 6:4, bank_pct: file? 6:5, slope_pct: file? 3:2, jumps: file? 2:1, waves: file? 1:0, lc: file? 2:1, grip_hint: "medio"};
}
function detectCar(file){
  // DEMO: FM-A con set B-MAX classico; valori variano leggermente se carichi un file
  const delta=file?0.2:0;
  return {
    chassis: chassis.toUpperCase(),
    mass_total_g: 112.0+delta,
    roller_front:{diameter_mm:19, position:"over"},
    roller_rear:{diameter_mm:13, position:"under"},
    damper:{pos:"center_top", mass_g:12},
    brake:{rear_mm: (lastTrack.jumps?2.0:1.5), front_mm:0.0},
    tires:{diameter_mm: (lastTrack.jumps?26:30), hardness: (lastTrack.jumps?"soft":"hard")}
  };
}
/* ====== OPTIMIZER ====== */
$("#btnOpt").onclick=()=>{
  if(!lastTrack.length_m) lastTrack=detectTrack(null);
  if(!lastCar.chassis) lastCar=detectCar(null);
  const res = optimize(lastTrack,lastCar);
  lastSetup=res; renderPins(res); renderPanels(res);
  toast("Setup vincente generato.");
};
function optimize(t,c){
  const holesTop=HOLES[chassis].top, holesBot=HOLES[chassis].bottom;
  const near=(arr,x,y)=>arr.reduce((a,b)=>Math.hypot(b[0]-x,b[1]-y)<Math.hypot(a[0]-x,a[1]-y)?b:a);
  const place=[], L=(x,y)=>near(holesTop,x,y), LB=(x,y)=>near(holesBot,x,y), log=[];
  // Gear + motore
  const ratio = (t.length_m>80 && t.jumps===0) ? "3.5:1" : "3.7:1";
  const motor = (t.jumps>0 || t.lc>0) ? "Torque/Rev (B-MAX consentiti)" : "Atomic/High-Rev (se consentito)";
  log.push(`Gear → ${ratio}`); log.push(`Motore → ${motor}`);
  // Roller combo
  const rF=L(170,36); place.push(pin('Roller','Roller 19mm (over, front)',rF[0],rF[1],'vite 2×15 + washer 1mm'));
  const rR=LB(48,88); place.push(pin('Roller','Roller 13mm (under, rear)',rR[0],rR[1],'vite 2×15 + spacer 3mm','under'));
  // Damper
  const dm=L(96,104); place.push(pin('Damper','Damper 12g centrale',dm[0],dm[1],'corsa libera ±2mm'));
  // Stay post
  const st=L(28,96); place.push(pin('Piastra','Stay posteriore FRP',st[0],st[1],'viti 2×10 + dadi nylon'));
  // Freni
  const thick=(t.jumps>0||t.bank_pct>=6)?2.0:1.5;
  const br=LB(100,100); place.push(pin('Freni',`Freno ${thick.toFixed(1)}mm (bottom)`,br[0],br[1],`ground ≥1.2mm`));
  // Gomme
  const tires=(t.length_m>80 && t.jumps===0)?'30mm hard':'26mm soft';
  place.push(pin('Gomme',`Gomme ${tires}`,130,70,'larghezza 8–26mm'));
  // Ferramenta
  place.push(pin('Ferramenta','Viti M2 10/15mm • washer 1mm • spacer 3mm',60,70,'solo Tamiya'));
  // Stime
  const weight = 95 + 1.0 + 3.2 + 12 + 3.8 + (thick===2?4.5:3.2) + 1.2;
  const mu = tires.includes('soft')?0.9:0.8;
  const R=0.8, g=9.81, theta=t.bank_pct/100, v_curve=Math.sqrt(mu*g*R), v_bank=Math.sqrt((mu*g*R)/(Math.tan(theta)+mu));
  const v_base = Math.min(v_curve,v_bank) * (tires.includes('30')?1.05:1.0);
  const v_jump = t.jumps? v_base*0.92 : v_base;
  const v = Math.max(7.8, Math.min(9.6, v_jump));
  const stability = 88 + (thick===2?4:2) + (tires.includes('soft')?2:0);
  // B-MAX check (semplice)
  const notes=[]; const ok=true; // quote fisiche verificate in step successivo con catalogo
  return {place, log, spec:{ratio,motor,tires,thick,weight,speed:v,stability:Math.min(100,Math.round(stability))}, bmax:{ok,notes}, track:t, car:c};
}
function pin(cat,title,x,y,detail,under=''){return {cat,title,x,y,detail,under};}
/* ====== RENDER PINS & PANELS ====== */
function renderPins(res){
  gPins.innerHTML=''; let i=1;
  for(const p of res.place){
    const g=svgEl('g',{class:`pin ${cls(p.cat)} ${p.under?'under':''}`});
    const c=svgEl('circle',{cx:p.x,cy:p.y,r:4}); const t=svgEl('text',{x:p.x,y:p.y+.8,'text-anchor':'middle'}); t.textContent=i++;
    g.append(c,t); gPins.appendChild(g);
    g.addEventListener('mouseenter',ev=>tip(ev, `${p.title}\n${p.detail}`));
    g.addEventListener('mouseleave',hideTip);
    g.addEventListener('click',()=> showSummary(p));
  }
}
function renderPanels(res){
  sum.innerHTML = `
    <div>Peso stimato</div><div><b>${res.spec.weight.toFixed(1)} g</b></div>
    <div>Velocità media</div><div><b>${res.spec.speed.toFixed(2)} m/s</b></div>
    <div>Stabilità</div><div><b>${res.spec.stability}/100</b></div>
    <div>Gomme</div><div>${res.spec.tires}</div>
    <div>Freno</div><div>${res.spec.thick.toFixed(1)} mm</div>
    <div>Rapporto</div><div>${res.spec.ratio}</div>
    <div>Motore</div><div>${res.spec.motor}</div>`;
  log.textContent = res.log.join('\n');
  bmx.innerHTML = res.bmax.ok ? `<span class="ok">OK B-MAX</span>` : `<span class="bad">NON conforme</span>\n${res.bmax.notes.join('\n')}`;
  trackOut.textContent = JSON.stringify(res.track,null,2);
  carOut.textContent   = JSON.stringify(res.car,null,2);
}
function showSummary(p){
  sum.innerHTML = `
    <div>Componente</div><div><b>${p.title}</b> <span class="pill">${p.cat}</span></div>
    <div>Montaggio</div><div>${p.detail}${p.under?' • under':''}</div>
    <div>Foro</div><div>X:${p.x.toFixed(1)} • Y:${p.y.toFixed(1)} (scala ${scalePXperMM? (1/scalePXperMM).toFixed(2):'—'} mm/px)</div>
    <div>Item No.</div><div>— <i>(si riempie collegando il catalogo Tamiya ufficiale)</i></div>`;
}
function cls(cat){return {Roller:'roll',Freni:'brake',Damper:'damp',Piastra:'stay',Gomme:'tire',Ferramenta:'hw'}[cat]||'hw';}
/* ====== CATALOG (placeholder locale ricercabile) ====== */
const CATALOG=[
  {cat:'Roller', name:'Roller 19mm', item:'—', mass_g:3.2, note:'over front'},
  {cat:'Roller', name:'Roller 13mm', item:'—', mass_g:1.9, note:'under rear'},
  {cat:'Freni', name:'Foam 1.5mm', item:'—', mass_g:3.2, note:'bottom'},
  {cat:'Freni', name:'Foam 2.0mm', item:'—', mass_g:4.5, note:'bottom'},
  {cat:'Damper', name:'Damper 12g', item:'—', mass_g:12, note:'center'},
  {cat:'Piastre', name:'Stay post FRP', item:'—', mass_g:3.8, note:'rear'},
  {cat:'Gomme', name:'26mm soft', item:'—', mass_g:1.2, note:'LP'},
  {cat:'Gomme', name:'30mm hard', item:'—', mass_g:1.4, note:'LP'},
  {cat:'Ferramenta', name:'Vite M2 15mm', item:'—', mass_g:0.3, note:'steel'},
  {cat:'Ferramenta', name:'Spacer 3mm', item:'—', mass_g:0.2, note:'alum'},
  {cat:'Ferramenta', name:'Washer 1mm', item:'—', mass_g:0.1, note:'steel'}
];
function renderTable(list){
  tbl.innerHTML='<tr><th>Categoria</th><th>Nome</th><th>Item No.</th><th>Peso (g)</th><th>Note</th></tr>'+
    list.map(x=>`<tr><td>${x.cat}</td><td>${x.name}</td><td>${x.item}</td><td>${x.mass_g}</td><td>${x.note}</td></tr>`).join('');
}
renderTable(CATALOG);
q.addEventListener('input',()=>{const s=q.value.toLowerCase(); renderTable(CATALOG.filter(x=>Object.values(x).join(' ').toLowerCase().includes(s)));});
/* ====== EXPORT ====== */
$("#btnPDF").onclick=()=>window.print();
$("#btnJSON").onclick=()=>{
  const blob=new Blob([JSON.stringify({track:lastTrack,car:lastCar,setup:lastSetup},null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bmax_report.json'; a.click(); URL.revokeObjectURL(a.href);
};
/* ====== EVENTS & INIT ====== */
selCh.onchange=e=>{chassis=e.target.value; draw();};
selV.onchange=e=>{view=e.target.value; draw();};
draw();
/* ====== UI helpers ====== */
function svgEl(tag,attrs){const el=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs) el.setAttribute(k,attrs[k]); return el;}
function tip(ev,txt){tt.innerText=txt; tt.style.display='block'; tt.style.left=(ev.clientX+12)+'px'; tt.style.top=(ev.clientY-26)+'px';}
function hideTip(){tt.style.display='none';}
function toast(msg){tt.innerText=msg;tt.style.display='block';tt.style.left='16px';tt.style.top='16px';setTimeout(()=>tt.style.display='none',1800);}
</script>
</body>
</html>
