<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>B-MAX Advisor • Demo</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{color-scheme:light dark}
  .badge{ @apply inline-flex items-center gap-2 px-2 py-0.5 rounded-full text-xs font-medium; }
  .panel{ @apply p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60; }
  .tab[aria-selected="true"]{ @apply bg-blue-600 text-white shadow; }
  /* SVG */
  .grid line{ stroke:#1f2937; stroke-opacity:.25; }
  .chassis{ fill:#0b1320; stroke:#6b7280; stroke-width:1.5; }
  .hole{ fill:#334155; }
  .mk{ cursor:pointer; filter:drop-shadow(0 0 6px rgba(0,0,0,.35)); stroke:#0005; stroke-width:.6 }
  .mk.roller{ fill:#3aa0ff } .mk.brake{ fill:#ff4d5a } .mk.damper{ fill:#ffd166 }
  .mk.plate{ fill:#475569 } .mk.wheel{ fill:#cbd5e1 } .mk.hw{ fill:#d1d5db }
  .ruler{ stroke:#a8b1c3; stroke-width:1.4; marker-end:url(#arr) }
  .legend-dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
</style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100">
<header class="sticky top-0 z-40 backdrop-blur bg-white/70 dark:bg-slate-900/70 border-b border-slate-200 dark:border-slate-800">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-xl bg-blue-600"></div>
      <h1 class="text-lg md:text-xl font-bold tracking-tight">B-MAX Advisor</h1>
      <span class="ml-2 text-xs px-2 py-1 rounded bg-amber-100 text-amber-800 dark:bg-amber-400/20 dark:text-amber-200">Demo UI</span>
    </div>
    <nav class="flex gap-2" role="tablist" aria-label="Sezioni">
      <button class="tab px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700" aria-selected="true" data-tab="track">Track</button>
      <button class="tab px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700" aria-selected="false" data-tab="car">Car</button>
      <button class="tab px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700" aria-selected="false" data-tab="optimizer">Optimizer</button>
      <button class="tab px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700" aria-selected="false" data-tab="catalog">Catalog</button>
    </nav>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
  <!-- TRACK -->
  <section id="tab-track" role="tabpanel" class="grid gap-6">
    <div class="flex items-start justify-between">
      <div>
        <h2 class="text-lg font-semibold">Track detector (demo)</h2>
        <p class="text-sm text-slate-500">Carica 2–4 foto (20–30% sovrapposizione) oppure usa il sample. Esporta JSON.</p>
      </div>
      <div class="flex items-center gap-2">
        <span id="trk-qual" class="badge bg-slate-200 dark:bg-slate-800">quality: —</span>
      </div>
    </div>

    <div class="grid md:grid-cols-[1fr,420px] gap-6">
      <div class="space-y-4">
        <div class="panel">
          <label class="block text-sm font-medium mb-2">Foto pista</label>
          <input id="trk-files" type="file" accept="image/*" multiple class="block w-full text-sm" />
          <div class="mt-3 flex gap-2">
            <button id="btn-trk-run" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Rileva</button>
            <button id="btn-trk-sample" class="px-3 py-2 rounded-lg border border-blue-600 text-blue-700">Sample</button>
            <button id="btn-trk-export" class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700">Export JSON</button>
          </div>
        </div>

        <div class="panel">
          <h3 class="font-medium mb-3">Moduli riconosciuti</h3>
          <div id="trk-list" class="grid gap-2"></div>
        </div>
      </div>

      <div class="panel">
        <h3 class="font-medium mb-3">Output (.track JSON)</h3>
        <textarea id="trk-json" class="w-full h-[420px] text-xs font-mono p-3 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950"></textarea>
      </div>
    </div>
  </section>

  <!-- CAR -->
  <section id="tab-car" role="tabpanel" class="grid gap-6 hidden">
    <div class="flex items-start justify-between">
      <div>
        <h2 class="text-lg font-semibold">Car detector (demo)</h2>
        <p class="text-sm text-slate-500">Allinea la foto al telaio (FM-A sample) e vedi componenti/masse. Check B-MAX.</p>
      </div>
      <div class="flex items-center gap-2">
        <span id="car-stats" class="badge bg-slate-200 dark:bg-slate-800">peso: —</span>
      </div>
    </div>

    <div class="grid md:grid-cols-[1fr,420px] gap-6">
      <div class="space-y-4">
        <div class="panel">
          <label class="block text-sm font-medium mb-2">Foto macchina</label>
          <input id="car-file" type="file" accept="image/*" class="block w-full text-sm" />
          <div class="mt-3 flex gap-2">
            <button id="btn-car-run" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Rileva</button>
            <button id="btn-car-sample" class="px-3 py-2 rounded-lg border border-blue-600 text-blue-700">Sample</button>
            <button id="btn-car-export" class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700">Export JSON</button>
          </div>
        </div>

        <div class="panel">
          <div class="flex items-center justify-between">
            <h3 class="font-medium mb-3">FM-A blueprint (Top/Bottom)</h3>
            <div class="flex gap-2 text-xs">
              <button class="px-2 py-1 rounded border border-slate-300 dark:border-slate-700" data-view="top">Top</button>
              <button class="px-2 py-1 rounded border border-slate-300 dark:border-slate-700" data-view="bottom">Bottom</button>
            </div>
          </div>
          <!-- SVG semplificato ma pulito -->
          <div class="rounded-xl overflow-hidden border border-slate-200 dark:border-slate-800 bg-slate-900">
            <svg id="svg" viewBox="0 0 1200 600">
              <defs>
                <marker id="arr" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto">
                  <path d="M0,0 L8,4 L0,8 z" fill="#a8b1c3"/>
                </marker>
              </defs>
              <g class="grid" id="grid"></g>
              <!-- Sagoma FM-A stilizzata (placeholder finché non colleghiamo l’outline ufficiale) -->
              <path class="chassis" d="M160,80 H1040 a40,40 0 0 1 40,40 v360 a40,40 0 0 1 -40,40 H160 a40,40 0 0 1 -40,-40 V120 a40,40 0 0 1 40,-40 z" />
              <g id="holes"></g>
              <g id="L-roller"></g><g id="L-brake"></g><g id="L-damper"></g><g id="L-plate"></g><g id="L-wheel"></g><g id="L-hw"></g>
              <g id="measure"></g>
            </svg>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            Suggerimento: clicca 2 fori per misurare in mm; clic sui marker per aprire la scheda componente (Item No.: — in demo).
          </div>
          <div class="mt-3 flex flex-wrap gap-2 text-xs">
            <span class="badge bg-slate-200 dark:bg-slate-800"><span class="legend-dot" style="background:#3aa0ff"></span> Roller</span>
            <span class="badge bg-slate-200 dark:bg-slate-800"><span class="legend-dot" style="background:#ff4d5a"></span> Freni</span>
            <span class="badge bg-slate-200 dark:bg-slate-800"><span class="legend-dot" style="background:#ffd166"></span> Damper</span>
            <span class="badge bg-slate-200 dark:bg-slate-800"><span class="legend-dot" style="background:#475569"></span> Piastre</span>
            <span class="badge bg-slate-200 dark:bg-slate-800"><span class="legend-dot" style="background:#cbd5e1"></span> Gomme</span>
          </div>
        </div>

        <div class="panel">
          <h3 class="font-medium mb-3">Componenti rilevati</h3>
          <div id="car-list" class="grid gap-2"></div>
        </div>
      </div>

      <div class="panel">
        <h3 class="font-medium mb-3">Output (.car JSON)</h3>
        <textarea id="car-json" class="w-full h-[420px] text-xs font-mono p-3 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950"></textarea>
      </div>
    </div>
  </section>

  <!-- OPTIMIZER -->
  <section id="tab-optimizer" role="tabpanel" class="grid gap-6 hidden">
    <div class="flex items-start justify-between">
      <div>
        <h2 class="text-lg font-semibold">Optimizer (demo)</h2>
        <p class="text-sm text-slate-500">Calcolo giro stimato + stabilità. Restituisce 1 setup B-MAX (demo).</p>
      </div>
      <span id="opt-state" class="badge bg-slate-200 dark:bg-slate-800">ready</span>
    </div>

    <div class="grid md:grid-cols-[1fr,420px] gap-6">
      <div class="space-y-4">
        <div class="panel">
          <div class="flex flex-wrap gap-2">
            <button id="btn-load-current" class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700">Usa Track+Car correnti</button>
            <button id="btn-run-opt" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Calcola</button>
            <button id="btn-export-report" class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700">Export Report</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="panel">
            <h3 class="font-medium mb-2">Risultati</h3>
            <ul id="opt-results" class="text-sm grid gap-1"></ul>
          </div>
          <div class="panel">
            <h3 class="font-medium mb-2">Setup proposto</h3>
            <ul id="opt-setup" class="text-sm grid gap-1"></ul>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3 class="font-medium mb-3">Log</h3>
        <pre id="opt-log" class="text-xs font-mono whitespace-pre-wrap"></pre>
      </div>
    </div>
  </section>

  <!-- CATALOG -->
  <section id="tab-catalog" role="tabpanel" class="grid gap-6 hidden">
    <div class="flex items-start justify-between">
      <div>
        <h2 class="text-lg font-semibold">Catalog (demo)</h2>
        <p class="text-sm text-slate-500">Ricerca base. I codici ufficiali saranno collegati nella build completa.</p>
      </div>
      <span id="cat-count" class="badge bg-slate-200 dark:bg-slate-800">0 items</span>
    </div>

    <div class="panel">
      <div class="grid md:grid-cols-3 gap-3">
        <input id="q" class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700" placeholder="Cerca nome o codice…" />
        <select id="tag" class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700">
          <option value="">Tutti i tag</option><option>roller</option><option>plate</option><option>damper</option><option>tire</option><option>gear</option><option>brake</option>
        </select>
        <label class="inline-flex items-center gap-2 text-sm"><input id="only-bmax" type="checkbox" class="h-4 w-4" /> B-MAX</label>
      </div>
    </div>

    <div id="cat-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </section>
</main>

<footer class="max-w-6xl mx-auto px-4 pb-10 pt-4 text-xs text-slate-500">
  <p>Demo UI offline: i detector/optimizer qui sono simulati per provare l’interfaccia. Nella versione completa verranno sostituiti dai modelli reali e collegati al catalogo ufficiale Tamiya.</p>
</footer>

<!-- DIALOG scheda componente -->
<dialog id="sheet" class="max-w-md w-[92vw] rounded-xl border border-slate-700 bg-slate-900 text-slate-100">
  <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700">
    <strong>Scheda componente</strong>
    <button id="sheet-close" class="px-2 py-1 rounded border border-slate-600">Chiudi</button>
  </div>
  <div class="p-4 text-sm">
    <div id="p-cat" class="text-slate-400">—</div>
    <div class="text-base font-medium my-1" id="p-name">—</div>
    <div>Item No.: <span id="p-code">—</span></div>
    <div class="mt-1 text-slate-400">Peso: <span id="p-wt">—</span> • Dimensioni: <span id="p-dim">—</span></div>
    <div class="mt-2 text-slate-400">Vista: <span id="p-view">—</span></div>
  </div>
</dialog>

<script>
const $ = (s,el=document)=>el.querySelector(s); const $$=(s,el=document)=>[...el.querySelectorAll(s)];
function pretty(o){return JSON.stringify(o,null,2)}
function dl(name,text){const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=name;a.click();URL.revokeObjectURL(a.href)}

// Tabs
$$('.tab').forEach(b=>b.addEventListener('click',()=>{ $$('.tab').forEach(t=>t.setAttribute('aria-selected','false')); b.setAttribute('aria-selected','true'); $$('#tab-track,#tab-car,#tab-optimizer,#tab-catalog').forEach(p=>p.classList.add('hidden')); $('#tab-'+b.dataset.tab).classList.remove('hidden'); }));

/* ====== TRACK (demo) ====== */
const sampleTrack = {
  version:'1.3',
  modules:[
    {type:'straight', pose:{x_mm:0,y_mm:0,theta_deg:0}, size:{length_mm:700}, confidence:0.99},
    {type:'curve_45_bank', pose:{x_mm:700,y_mm:0,theta_deg:45}, size:{arc_mm:310,radius_mm:230}, confidence:0.97, flags:['banked']},
    {type:'slope_up', pose:{x_mm:900,y_mm:200,theta_deg:0}, size:{length_mm:700,slope_deg:12}, confidence:0.94, flags:['needs_review']},
    {type:'wave', pose:{x_mm:1600,y_mm:200,theta_deg:0}, size:{length_mm:620}, confidence:0.96},
    {type:'straight', pose:{x_mm:2220,y_mm:200,theta_deg:0}, size:{length_mm:700}, confidence:0.98}
  ],
  quality:{coverage_pct:94, stitch_photos:3, global_confidence:0.95}
};
function renderTrack(t){
  $('#trk-json').value = pretty(t);
  $('#trk-qual').textContent = `coverage: ${t.quality.coverage_pct}% • conf: ${Math.round(t.quality.global_confidence*100)}%`;
  const list=$('#trk-list'); list.innerHTML='';
  t.modules.forEach((m,i)=>{
    const row=document.createElement('div');
    row.className='grid grid-cols-[1fr,auto] items-center gap-2 p-2 rounded-lg border border-slate-200 dark:border-slate-800';
    row.innerHTML=`<div class="text-sm"><b>${i+1}. ${m.type}</b> <span class="text-slate-500 ml-2">θ ${m.pose.theta_deg}°</span> ${m.flags?.includes('banked')?'<span class="badge bg-indigo-100 text-indigo-800 dark:bg-indigo-400/20 dark:text-indigo-200 ml-2">banked</span>':''}</div><div class="text-xs">conf ${Math.round(m.confidence*100)}%</div>`;
    list.appendChild(row);
  });
}
renderTrack(structuredClone(sampleTrack));
$('#btn-trk-sample').onclick=()=>renderTrack(structuredClone(sampleTrack));
$('#btn-trk-export').onclick=()=>dl('track.json',$('#trk-json').value||pretty(sampleTrack));
$('#btn-trk-run').onclick=()=>{ const f=$('#trk-files').files.length; const t=structuredClone(sampleTrack); if(f>0){t.quality.coverage_pct=Math.min(100,70+f*10)} renderTrack(t) };

/* ====== CAR (demo con SVG) ====== */
const svg=$("#svg"), grid=$("#grid"), holesG=$("#holes"), L={
  roller:$("#L-roller"), brake:$("#L-brake"), damper:$("#L-damper"), plate:$("#L-plate"), wheel:$("#L-wheel"), hw:$("#L-hw")
};
const vb=[0,0,220,200], SX=1200, SY=600, sx=SX/(vb[2]-vb[0]), sy=SY/(vb[3]-vb[1]);
const px=x=>x*sx, py=y=>y*sy;

// Griglia 10 mm
for(let xm=0; xm<=vb[2]; xm+=10){ const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',px(xm)); ln.setAttribute('y1',0); ln.setAttribute('x2',px(xm)); ln.setAttribute('y2',SY); grid.appendChild(ln) }
for(let ym=0; ym<=vb[3]; ym+=10){ const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',0); ln.setAttribute('y1',py(ym)); ln.setAttribute('x2',SX); ln.setAttribute('y2',py(ym)); grid.appendChild(ln) }

// Fori demo (posizioni indicative in mm)
const HOLES_MM = [[50,16],[60,16],[70,16],[80,16],[90,16],[100,16],[110,16],[120,16],[130,16],[140,16],[150,16],[160,16],[170,16],[180,16],[190,16],
                  [55,26],[65,26],[75,26],[85,26],[95,26],[105,26],[115,26],[125,26],[135,26],[145,26],[155,26],[165,26],[175,26],[185,26],[195,26],
                  [55,168],[65,168],[75,168],[85,168],[95,168],[105,168],[115,168],[125,168],[135,168],[145,168],[155,168],[165,168],[175,168],[185,168],[195,168],
                  [50,158],[60,158],[70,158],[80,158],[90,158],[100,158],[110,158],[120,158],[130,158],[140,158],[150,158],[160,158],[170,158],[180,158],[190,158]];
const HOLES=[]; HOLES_MM.forEach(([xm,ym])=>{ const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('class','hole'); c.setAttribute('r',3.6); c.setAttribute('cx',px(xm)); c.setAttribute('cy',py(ym)); holesG.appendChild(c); HOLES.push(c) });

function mk(type,attrs){ const el=document.createElementNS('http://www.w3.org/2000/svg',type); Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k,v)); el.classList.add('mk'); if(attrs.className) el.classList.add(attrs.className); return el }
function nearestHole(x_mm,y_mm){ let best=null,bd=1e9; for(const h of HOLES){ const dx=h.cx.baseVal.value-px(x_mm), dy=h.cy.baseVal.value-py(y_mm), d=dx*dx+dy*dy; if(d<bd){bd=d; best=h} } return best }

function place(type,x_mm,y_mm,cls,meta){ const h=nearestHole(x_mm,y_mm); const el = mk(type, Object.assign({cx:h.cx.baseVal.value, cy:h.cy.baseVal.value, r:10, className:cls}, meta||{})); return el }
function rectMM(x,y,w,h,cls,meta){ return mk('rect', Object.assign({x:px(x),y:py(y),width:w*sx,height:h*sy,rx:3, className:cls}, meta||{})) }

function loadTop(){
  L.roller.innerHTML=L.brake.innerHTML=L.damper.innerHTML=L.plate.innerHTML=L.wheel.innerHTML=L.hw.innerHTML='';
  L.roller.appendChild(place('circle',50,16,'roller',{'data-name':'Roller 19 mm (over)','data-cat':'roller','data-view':'Top'}));
  L.roller.appendChild(place('circle',200,16,'roller',{'data-name':'Roller 19 mm (over)','data-cat':'roller','data-view':'Top'}));
  L.roller.appendChild(place('circle',55,168,'roller',{'r':8,'data-name':'Roller 13 mm (under)','data-cat':'roller','data-view':'Top'}));
  L.roller.appendChild(place('circle',195,168,'roller',{'r':8,'data-name':'Roller 13 mm (under)','data-cat':'roller','data-view':'Top'}));
  L.plate.appendChild(rectMM(48,13,124,3.5,'plate',{'data-name':'FRP Front Stay','data-cat':'plate','data-view':'Top'}));
  L.damper.appendChild(rectMM(108,130,12,4,'damper',{'data-name':'Mass Damper 12 g','data-cat':'damper','data-view':'Top','data-weight':'12 g'}));
  L.wheel.appendChild(mk('circle',{className:'wheel',cx:px(70),cy:py(100),r:13*sx,'data-name':'Wheel/Tire','data-cat':'wheel','data-view':'Top'}));
  L.wheel.appendChild(mk('circle',{className:'wheel',cx:px(180),cy:py(100),r:13*sx,'data-name':'Wheel/Tire','data-cat':'wheel','data-view':'Top'}));
}
function loadBottom(){
  L.roller.innerHTML=L.brake.innerHTML=L.damper.innerHTML=L.plate.innerHTML=L.wheel.innerHTML=L.hw.innerHTML='';
  L.brake.appendChild(rectMM(88,170,44,2.5,'brake',{'data-name':'Brake sponge 2.5 mm','data-cat':'brake','data-view':'Bottom','data-size':'2.5 mm'}));
  L.plate.appendChild(rectMM(92,165,36,3,'plate',{'data-name':'Under Guard','data-cat':'plate','data-view':'Bottom'}));
}
loadTop();
$$('[data-view]').forEach(b=>b.addEventListener('click',()=>{ b.dataset.view==='top'?loadTop():loadBottom() }));

// Misure su due fori
const measureG=$("#measure"); let sel=[];
svg.addEventListener('click',e=>{
  if(e.target.classList.contains('hole')){ sel.push(e.target); if(sel.length>2) sel=[e.target]; drawMeasure() }
  if(e.target.classList.contains('mk')) openSheet(e.target);
});
function drawMeasure(){
  measureG.innerHTML='';
  if(sel.length<2) return;
  const [a,b]=sel; const ax=a.cx.baseVal.value, ay=a.cy.baseVal.value, bx=b.cx.baseVal.value, by=b.cy.baseVal.value;
  const pxlen=Math.hypot(bx-ax,by-ay), mm=(pxlen*0.24).toFixed(2); // scala demo
  const l=mk('line',{x1:ax,y1:ay,x2:bx,y2:by,className:'ruler'}); measureG.appendChild(l);
  const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',(ax+bx)/2); t.setAttribute('y',(ay+by)/2-6); t.setAttribute('fill','#cbd5e1'); t.setAttribute('font-size','12'); t.setAttribute('text-anchor','middle'); t.textContent=`${mm} mm`; measureG.appendChild(t);
}

// Scheda componente
const dlg=$("#sheet"), close=$("#sheet-close");
function openSheet(t){ $("#p-cat").textContent=(t.dataset.cat||'').toUpperCase(); $("#p-name").textContent=t.dataset.name||'-'; $("#p-code").textContent='—'; $("#p-wt").textContent=t.dataset.weight||'—'; $("#p-dim").textContent=t.dataset.size||'—'; $("#p-view").textContent=t.dataset.view||'-'; dlg.showModal() }
close.onclick=()=>dlg.close();

// Car JSON demo
const sampleCar={ chassis:'FM-A', weight_g:114.5, dimensions_mm:{length:156,width:104,height:45}, wheelbase_mm:80,
  components:[ {type:'roller_front', width_mm:104, dia_mm:19, pos:'top', flags:['bmax_ok']},
               {type:'roller_rear',  width_mm:98,  dia_mm:13, pos:'under', flags:['bmax_ok']},
               {type:'damper_rear',  mass_g:12, style:'hanging', flags:['bmax_ok']},
               {type:'plate_front',  material:'FRP', thickness_mm:1.5, flags:['bmax_ok']},
               {type:'tire', compound:'soft', dia_mm:26, width_mm:8.5, flags:['bmax_ok']},
               {type:'gear', ratio:'3.5:1', flags:['bmax_ok']},
               {type:'brake', material:'sponge', thickness_mm:2.5, flags:['bmax_ok']} ],
  legality:{bmax:true, notes:[]}
};
function renderCar(c){ $('#car-json').value=pretty(c); $('#car-stats').textContent=`peso: ${c.weight_g} g`; const wrap=$("#car-list"); wrap.innerHTML=''; c.components.forEach((cmp,i)=>{ const row=document.createElement('div'); row.className='grid grid-cols-[1fr,auto] items-center gap-2 p-2 rounded-lg border border-slate-200 dark:border-slate-800'; row.innerHTML=`<div class="text-sm"><b>${i+1}. ${cmp.type}</b> <span class="text-slate-500 ml-2">${cmp.pos||''}</span> ${cmp.flags?.includes('bmax_ok')?'<span class="badge bg-emerald-100 text-emerald-800 dark:bg-emerald-400/20 dark:text-emerald-200 ml-2">B-MAX</span>':''}</div><div class="text-xs">${cmp.dia_mm?cmp.dia_mm+' mm':''}${cmp.mass_g?cmp.mass_g+' g':''}</div>`; wrap.appendChild(row) }); }
renderCar(structuredClone(sampleCar));
$('#btn-car-sample').onclick=()=>renderCar(structuredClone(sampleCar));
$('#btn-car-export').onclick=()=>dl('car.json',$('#car-json').value||pretty(sampleCar));
$('#btn-car-run').onclick=()=>{ const c=structuredClone(sampleCar); const f=$('#car-file').files[0]; if(f){ c.weight_g=+(c.weight_g+0.5).toFixed(1) } renderCar(c) };

/* ====== CATALOG (demo) ====== */
const catalog=[ {itemNo:'—', name:'Roller alluminio 19 mm', weight_g:2.4, tags:['roller'], bmax:true},
                {itemNo:'—', name:'Roller alluminio 13 mm', weight_g:1.6, tags:['roller'], bmax:true},
                {itemNo:'—', name:'Mass damper 12 g', weight_g:12.0, tags:['damper'], bmax:true},
                {itemNo:'—', name:'FRP Front Stay', weight_g:6.2, tags:['plate'], bmax:true},
                {itemNo:'—', name:'Gomme soft 26 mm', weight_g:6.4, tags:['tire'], bmax:true},
                {itemNo:'—', name:'Gear 3.5:1', weight_g:2.2, tags:['gear'], bmax:true},
                {itemNo:'—', name:'Brake sponge 2.5 mm', weight_g:1.8, tags:['brake'], bmax:true} ];
function renderCatalog(list){ $('#cat-count').textContent=`${list.length} items`; const grid=$("#cat-grid"); grid.innerHTML=''; list.forEach(it=>{ const card=document.createElement('div'); card.className='panel'; card.innerHTML=`<div class="flex items-start justify-between"><div><div class="text-sm text-slate-500">${it.itemNo}</div><div class="font-medium">${it.name}</div></div>${it.bmax?'<span class="badge bg-emerald-100 text-emerald-800 dark:bg-emerald-400/20 dark:text-emerald-200">B-MAX</span>':''}</div><div class="mt-2 text-sm text-slate-600">${it.weight_g} g</div><div class="mt-2 flex flex-wrap gap-1">${it.tags.map(t=>`<span class='badge bg-slate-200 dark:bg-slate-800'>${t}</span>`).join('')}</div>`; grid.appendChild(card) }); }
renderCatalog(catalog);
function filterCatalog(){ const q=$('#q').value.toLowerCase(), tag=$('#tag').value, only=$('#only-bmax').checked; const items=catalog.filter(it=>(!q||it.name.toLowerCase().includes(q)||String(it.itemNo).includes(q))&&(!tag||it.tags.includes(tag))&&(!only||it.bmax)); renderCatalog(items) }
$('#q').oninput=filterCatalog; $('#tag').onchange=filterCatalog; $('#only-bmax').onchange=filterCatalog;

/* ====== OPTIMIZER (demo) ====== */
function lengthTrack(t){ return t.modules.reduce((a,m)=>a+(m.size.length_mm||m.size.arc_mm||0),0) }
function runOpt(){
  const t = JSON.parse($('#trk-json').value||'null') || sampleTrack;
  const c = JSON.parse($('#car-json').value||'null') || sampleCar;
  const L = lengthTrack(t)/1000; // m
  const base = 7.5; // m/s (mock)
  const slope = t.modules.filter(m=>m.type.includes('slope')).length*0.6;
  const wave  = t.modules.filter(m=>m.type.includes('wave')).length*0.4;
  const massK = (c.weight_g/1000)*0.25;
  const lap = (L/base)+slope+wave+massK;
  const stable = Math.max(0, 100 - (c.components.some(r=>r.type==='roller_front' && r.width_mm<100)?15:0) - (c.weight_g>120?8:0));
  $('#opt-results').innerHTML = `<li>Lunghezza pista: <b>${L.toFixed(2)} m</b></li><li>Lap stimato: <b>${lap.toFixed(2)} s</b></li><li>Indice stabilità: <b>${stable.toFixed(0)}/100</b></li><li>B-MAX: <b>${c.legality?.bmax!==false?'OK':'Check'}</b></li>`;
  $('#opt-setup').innerHTML = `<li><b>—</b> Roller 19 mm (top, front)</li><li><b>—</b> Roller 13 mm (under, rear)</li><li><b>—</b> FRP Front Stay</li><li><b>—</b> Brake sponge 2.5 mm (rear)</li><li><b>—</b> Gear 3.5:1</li><li><b>—</b> Gomme soft 26 mm</li>`;
  $('#opt-log').textContent = `• Optimizer eseguito (demo)\n• Moduli slope: ${t.modules.filter(m=>m.type.includes('slope')).length}\n• Moduli wave: ${t.modules.filter(m=>m.type.includes('wave')).length}\n• Peso car: ${c.weight_g} g`;
}
$('#btn-load-current').onclick=()=>{ $('#trk-json').value=pretty(sampleTrack); $('#car-json').value=pretty(sampleCar); }
$('#btn-run-opt').onclick=runOpt;
$('#btn-export-report').onclick=()=>{ const rep={ date:new Date().toISOString(), track: JSON.parse($('#trk-json').value||'null')||sampleTrack, car: JSON.parse($('#car-json').value||'null')||sampleCar, results: $('#opt-results').innerText, setup: $('#opt-setup').innerText }; dl('bmax_report.json', JSON.stringify(rep,null,2)) };
</script>
</body>
</html>
